<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trophy Upload Test - DA SPORTZ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .existing-image-card {
            border: 3px solid #28a745 !important;
            border-radius: 8px;
            overflow: hidden;
        }

        .existing-image-card-img-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            background: #f0f0f0;
        }

        .existing-image-card img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .existing-image-card-img-wrapper:hover .image-overlay {
            opacity: 1;
        }

        .delete-image-btn {
            background-color: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 10px 16px !important;
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
        }

        .delete-image-btn:hover {
            background-color: #c82333 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7) !important;
            transform: scale(1.05);
        }

        .image-label {
            background: #f0f0f0;
            padding: 8px;
            text-align: center;
            border-top: 1px solid #ddd;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h4 class="mb-0"><i class="bi bi-image me-2"></i>Trophy Image Upload Test</h4>
                    </div>
                    <div class="card-body">
                        <!-- Instructions -->
                        <div class="alert alert-info" role="alert">
                            <h5><i class="bi bi-info-circle me-2"></i>Test Instructions</h5>
                            <p class="mb-2">This page tests the trophy image upload functionality.</p>
                            <ol>
                                <li>Click "Enable Staff Mode" to show the form</li>
                                <li>Fill in trophy details</li>
                                <li>Upload images (JPG, PNG, WEBP, GIF - max 5MB each)</li>
                                <li>Watch for image previews</li>
                                <li>Submit the form to test backend integration</li>
                            </ol>
                        </div>

                        <!-- Staff Mode Toggle -->
                        <button class="btn btn-success mb-4" id="enableStaffBtn">
                            <i class="bi bi-check-circle me-2"></i>Enable Staff Mode
                        </button>

                        <!-- Trophy Form (Initially Hidden) -->
                        <div id="trophyAdminSection" style="display: none;">
                            <!-- Trophy List & Edit Section -->
                            <div class="mb-5">
                                <h5 class="mb-3 fw-bold">
                                    <i class="bi bi-list-check me-2"></i>Manage Trophies
                                </h5>
                                <div id="trophyListSection" class="row g-3" style="display: none;"></div>
                                <p id="noTrophiesMsg" class="text-muted">Loading trophies...</p>
                            </div>

                            <hr class="my-4">

                            <!-- Form Section -->
                            <h5 class="mb-3 fw-bold">
                                <i class="bi bi-plus-circle me-2"></i><span id="formTitleText">Add New Trophy</span>
                            </h5>
                            <form id="addTrophyForm" enctype="multipart/form-data">
                                <!-- Status Message -->
                                <div id="addTrophyStatus" class="alert alert-info d-none mb-3"></div>

                                <!-- Basic Information -->
                                <h5 class="mb-3 fw-bold">
                                    <i class="bi bi-info-circle me-2"></i>Basic Information
                                </h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Trophy Name *</label>
                                        <input type="text" class="form-control" name="name" required
                                            placeholder="e.g., Golden Cricket Trophy">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Category *</label>
                                        <input type="text" class="form-control" name="category"
                                            placeholder="e.g., Cricket, Football">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Price (â‚¹) *</label>
                                        <input type="number" class="form-control" name="price" required step="0.01"
                                            placeholder="e.g., 2500">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Height (inches) *</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="size" required step="0.1"
                                                min="0" placeholder="e.g., 12.5">
                                            <span class="input-group-text">in</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Description</label>
                                    <textarea class="form-control" name="description" rows="3"
                                        placeholder="Describe the trophy features..."></textarea>
                                </div>

                                <!-- Inventory Field -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">Inventory *</label>
                                        <input type="number" class="form-control" name="inventory" required min="0"
                                            value="0" placeholder="e.g., 10">
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-info-circle"></i> Number of trophies in stock
                                        </small>
                                    </div>
                                </div>

                                <!-- Flags -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="available"
                                                value="true" id="availableCheck" checked>
                                            <label class="form-check-label" for="availableCheck">
                                                Available for Purchase
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="customizable"
                                                value="true" id="customizableCheck" checked>
                                            <label class="form-check-label" for="customizableCheck">
                                                Customizable
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Existing Images (for edit mode) -->
                                <div id="existingImagesSection" style="display: none;" class="mb-4">
                                    <h5 class="mb-3 fw-bold">
                                        <i class="bi bi-images me-2"></i>Current Images
                                    </h5>
                                    <div id="existingImagesList" class="row g-3 mb-3"></div>
                                </div>

                                <!-- Image Upload -->
                                <h5 class="mb-3 fw-bold">
                                    <i class="bi bi-image me-2"></i>Trophy Images
                                </h5>
                                <div class="card bg-light border-2 border-dashed mb-3 p-4">
                                    <label class="form-label fw-semibold mb-2">
                                        Upload Multiple Images (JPG, PNG, WEBP, GIF - Max 5MB each) *
                                    </label>
                                    <input type="file" class="form-control" name="images" multiple
                                        accept="image/jpeg,image/png,image/webp,image/gif" id="trophyImagesInput">
                                    <small class="text-muted d-block mt-2">
                                        <i class="bi bi-info-circle"></i> At least one image is required. You can upload
                                        up to 3 images. All images
                                        will be displayed in the product gallery.
                                    </small>
                                </div>

                                <!-- New Image Preview -->
                                <div id="trophyImagePreview" class="mb-4"></div>

                                <!-- Submit Button -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-lg btn-success flex-grow-1">
                                        <i class="bi bi-check-circle me-2"></i><span id="submitBtnText">Add
                                            Trophy</span>
                                    </button>
                                    <button type="reset" class="btn btn-lg btn-outline-secondary">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset
                                    </button>
                                    <button type="button" id="cancelEditBtn" class="btn btn-lg btn-outline-danger"
                                        style="display: none;">
                                        <i class="bi bi-x-circle me-2"></i>Cancel Edit
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State management
        let currentEditingId = null;
        let existingImages = [];
        let imagesToDelete = [];

        // Enable Staff Mode
        document.getElementById('enableStaffBtn').addEventListener('click', function () {
            sessionStorage.setItem('staffUser', 'test-staff');
            document.getElementById('trophyAdminSection').style.display = 'block';
            this.style.display = 'none';
            loadTrophyList();
        });

        /**
         * Load and display list of trophies for editing
         */
        async function loadTrophyList() {
            console.log('=== loadTrophyList called ===');
            const listSection = document.getElementById('trophyListSection');
            const noMsg = document.getElementById('noTrophiesMsg');

            try {
                const response = await fetch(getBackendUrl() + '/api/trophies');
                const data = await response.json();

                console.log('API Response:', data);
                console.log('Trophies count:', data.trophies?.length);

                if (data.trophies && data.trophies.length > 0) {
                    noMsg.style.display = 'none';
                    listSection.style.display = 'flex';
                    listSection.innerHTML = '';

                    for (const trophy of data.trophies) {
                        console.log('Creating card for trophy:', trophy.name, 'with images:', trophy.images);

                        const col = document.createElement('div');
                        col.className = 'col-md-4 col-lg-3';

                        const card = document.createElement('div');
                        card.className = 'card shadow-sm h-100';

                        const img = document.createElement('img');
                        img.src = trophy.imageUrl || trophy.images?.[0] || 'https://images.unsplash.com/photo-1599351431202-1e0f0137899a?w=400';
                        img.className = 'card-img-top';
                        img.style.height = '180px';
                        img.style.objectFit = 'cover';
                        img.alt = trophy.name;

                        const body = document.createElement('div');
                        body.className = 'card-body d-flex flex-column';

                        const title = document.createElement('h6');
                        title.className = 'card-title';
                        title.textContent = trophy.name;

                        const price = document.createElement('p');
                        price.className = 'text-muted small mb-2';
                        price.textContent = `â‚¹${trophy.price}`;

                        const imageCount = document.createElement('p');
                        imageCount.className = 'text-muted small mb-3';
                        const imgCount = (trophy.images && trophy.images.length) || (trophy.imageUrl ? 1 : 0);
                        imageCount.innerHTML = `<i class="bi bi-images"></i> ${imgCount} image${imgCount !== 1 ? 's' : ''}`;

                        const btnGroup = document.createElement('div');
                        btnGroup.className = 'd-flex gap-2 mt-auto';

                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn btn-sm btn-primary flex-grow-1';
                        editBtn.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Edit';
                        editBtn.addEventListener('click', function (e) {
                            alert('EDIT BUTTON CLICKED! Trophy: ' + trophy.name);
                            try {
                                console.warn('>>> EDIT CLICKED <<<');
                                e.preventDefault();
                                console.log('EDIT BUTTON CLICKED for trophy:', trophy.name);
                                console.log('Trophy object being passed:', trophy);
                                loadTrophyForEditing(trophy);
                            } catch (err) {
                                console.error('ERROR IN EDIT CLICK HANDLER:', err);
                                alert('ERROR: ' + err.message);
                            }
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-danger';
                        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                        deleteBtn.addEventListener('click', () => deleteTrophy(trophy._id, trophy.name));

                        btnGroup.appendChild(editBtn);
                        btnGroup.appendChild(deleteBtn);

                        body.appendChild(title);
                        body.appendChild(price);
                        body.appendChild(imageCount);
                        body.appendChild(btnGroup);
                        card.appendChild(img);
                        card.appendChild(body);
                        col.appendChild(card);
                        listSection.appendChild(col);
                    }
                } else {
                    noMsg.textContent = 'No trophies found. Create one!';
                    noMsg.style.display = 'block';
                    listSection.style.display = 'none';
                }
            } catch (err) {
                console.error('Error loading trophies:', err);
                noMsg.textContent = 'Error loading trophies';
                noMsg.style.display = 'block';
            }
        }

        /**
         * Load trophy data into form for editing
         */
        async function loadTrophyForEditing(trophy) {
            console.log('=== Loading trophy for editing ===');
            console.log('Trophy object:', trophy);
            console.log('Trophy._id:', trophy._id);
            console.log('Trophy.images:', trophy.images);
            console.log('Trophy.imageUrl:', trophy.imageUrl);

            // IMPORTANT: Reset state FIRST before setting new data
            imagesToDelete = [];
            currentEditingId = trophy._id;

            // Determine images - prioritize images array, fallback to imageUrl
            if (trophy.images && Array.isArray(trophy.images) && trophy.images.length > 0) {
                existingImages = [...trophy.images]; // Create a copy
                console.log('Using trophy.images array:', existingImages);
            } else if (trophy.imageUrl) {
                existingImages = [trophy.imageUrl];
                console.log('Using trophy.imageUrl:', existingImages);
            } else {
                existingImages = [];
                console.warn('No images found on trophy');
            }

            console.log('Final existingImages:', existingImages);

            // Populate form fields
            document.getElementById('addTrophyForm').querySelector('input[name="name"]').value = trophy.name || '';
            document.getElementById('addTrophyForm').querySelector('input[name="category"]').value = trophy.category || '';
            document.getElementById('addTrophyForm').querySelector('input[name="price"]').value = trophy.price || '';
            document.getElementById('addTrophyForm').querySelector('input[name="size"]').value = trophy.size || '';
            document.getElementById('addTrophyForm').querySelector('textarea[name="description"]').value = trophy.description || '';
            document.getElementById('addTrophyForm').querySelector('input[name="available"]').checked = trophy.available !== false;
            document.getElementById('addTrophyForm').querySelector('input[name="customizable"]').checked = trophy.customizable !== false;

            // Clear file input but NOT the form
            document.getElementById('trophyImagesInput').value = '';
            document.getElementById('trophyImagePreview').innerHTML = '';

            // Small delay to ensure DOM is ready, then display existing images
            setTimeout(() => {
                console.log('Displaying existing images. Count:', existingImages.length);
                displayExistingImages();
            }, 100);

            // Update UI
            document.getElementById('formTitleText').textContent = `Edit: ${trophy.name}`;
            document.getElementById('submitBtnText').textContent = 'Save Changes';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Scroll to form
            const formSection = document.getElementById('addTrophyForm');
            formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Display existing images with delete option
         */
        function displayExistingImages() {
            console.log('=== displayExistingImages called ===');
            console.log('existingImages array:', existingImages);
            console.log('existingImages.length:', existingImages.length);

            const existingSection = document.getElementById('existingImagesSection');
            const existingList = document.getElementById('existingImagesList');

            if (!existingSection || !existingList) {
                console.error('Missing HTML elements - existingSection:', !!existingSection, 'existingList:', !!existingList);
                return;
            }

            if (!existingImages || existingImages.length === 0) {
                console.log('No existing images to display, hiding section');
                existingSection.style.display = 'none';
                existingList.innerHTML = '';
                return;
            }

            console.log(`Displaying ${existingImages.length} existing images`);
            existingSection.style.display = 'block';
            existingList.innerHTML = '';

            for (let i = 0; i < existingImages.length; i++) {
                const imageUrl = existingImages[i];

                // Skip empty or invalid URLs
                if (!imageUrl || typeof imageUrl !== 'string' || imageUrl.trim() === '') {
                    console.warn(`Skipping invalid image at index ${i}:`, imageUrl);
                    continue;
                }

                console.log(`Creating card for image ${i}: ${imageUrl.substring(0, 50)}...`);

                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';

                const card = document.createElement('div');
                card.className = 'existing-image-card card';

                // Create wrapper for image and delete button
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'existing-image-card-img-wrapper';

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `Trophy image ${i + 1}`;

                // Log when image loads
                img.addEventListener('load', () => {
                    console.log(`Image ${i} loaded successfully`);
                });

                img.addEventListener('error', () => {
                    console.error(`Image ${i} failed to load:`, imageUrl);
                });

                // Create overlay for delete button
                const overlay = document.createElement('div');
                overlay.className = 'image-overlay';

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'btn delete-image-btn';
                deleteBtn.title = 'Delete this image';
                deleteBtn.innerHTML = '<i class="bi bi-trash-fill"></i><span>Delete Image</span>';
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Delete button clicked for image', i, 'URL:', imageUrl);
                    deleteExistingImage(i);
                });

                overlay.appendChild(deleteBtn);
                imgWrapper.appendChild(img);
                imgWrapper.appendChild(overlay);

                const label = document.createElement('div');
                label.className = 'image-label';
                label.innerHTML = `<small class="text-success"><i class="bi bi-check-circle-fill"></i> Current Image</small>`;

                card.appendChild(imgWrapper);
                card.appendChild(label);
                col.appendChild(card);
                existingList.appendChild(col);
            }
            console.log('Finished displaying existing images');
        }

        /**
         * Delete an existing image
         */
        function deleteExistingImage(index) {
            if (confirm('Delete this image?')) {
                imagesToDelete.push(existingImages[index]);
                existingImages.splice(index, 1);
                displayExistingImages();
                showStatus(`Marked for deletion. Images will be removed when you save.`, 'warning');
            }
        }

        /**
         * Cancel editing
         */
        document.getElementById('cancelEditBtn').addEventListener('click', function () {
            cancelEdit();
        });

        function cancelEdit() {
            currentEditingId = null;
            existingImages = [];
            imagesToDelete = [];
            document.getElementById('addTrophyForm').reset();
            document.getElementById('existingImagesSection').style.display = 'none';
            document.getElementById('trophyImagePreview').innerHTML = '';
            document.getElementById('formTitleText').textContent = 'Add New Trophy';
            document.getElementById('submitBtnText').textContent = 'Add Trophy';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        /**
         * Delete a trophy completely
         */
        async function deleteTrophy(trophyId, trophyName) {
            if (!confirm(`Delete "${trophyName}" permanently?`)) return;

            try {
                showStatus('Deleting trophy...', 'info');
                const token = getToken();
                const response = await fetch(getBackendUrl() + `/api/trophies/${trophyId}`, {
                    method: 'DELETE',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });

                if (response.ok) {
                    showStatus(`Trophy "${trophyName}" deleted successfully!`, 'success');
                    loadTrophyList();
                } else {
                    showStatus('Failed to delete trophy', 'danger');
                }
            } catch (err) {
                showStatus('Error: ' + err.message, 'danger');
            }
        }

        // Trophy Admin Form Logic
        const trophyImagesInput = document.getElementById('trophyImagesInput');
        const imagePreview = document.getElementById('trophyImagePreview');
        const addForm = document.getElementById('addTrophyForm');
        const statusDiv = document.getElementById('addTrophyStatus');

        // Image preview handler
        if (trophyImagesInput) {
            trophyImagesInput.addEventListener('change', function (e) {
                imagePreview.innerHTML = '';
                const files = e.target.files;

                if (files.length > 0) {
                    const previewContainer = document.createElement('div');
                    previewContainer.className = 'row g-3 mb-3';

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];

                        // Validate file type
                        const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
                        if (!validTypes.includes(file.type)) {
                            showStatus(`Invalid file type: ${file.name}. Only JPEG, PNG, WEBP, GIF allowed.`, 'danger');
                            continue;
                        }

                        // Validate file size (5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showStatus(`File too large: ${file.name}. Max 5MB per image.`, 'danger');
                            continue;
                        }

                        const reader = new FileReader();
                        reader.onload = function (event) {
                            const col = document.createElement('div');
                            col.className = 'col-md-6 col-lg-4';

                            const card = document.createElement('div');
                            card.className = 'card border-0 shadow-sm overflow-hidden';

                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.className = 'card-img-top';
                            img.style.height = '150px';
                            img.style.objectFit = 'cover';
                            img.alt = file.name;

                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body p-2';

                            const fileName = document.createElement('small');
                            fileName.className = 'text-muted d-block text-truncate';
                            fileName.textContent = file.name;

                            const fileSize = document.createElement('small');
                            fileSize.className = 'text-muted';
                            fileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;

                            cardBody.appendChild(fileName);
                            cardBody.appendChild(fileSize);
                            card.appendChild(img);
                            card.appendChild(cardBody);
                            col.appendChild(card);
                            previewContainer.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }

                    imagePreview.appendChild(previewContainer);
                }
            });
        }

        // Form submission
        if (addForm) {
            addForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Validate required fields
                const name = addForm.querySelector('input[name="name"]').value.trim();
                const price = addForm.querySelector('input[name="price"]').value;
                const size = addForm.querySelector('input[name="size"]').value.trim();
                const inventory = addForm.querySelector('input[name="inventory"]').value.trim();
                const imageFiles = trophyImagesInput.files;
                const hasExistingImages = existingImages && existingImages.length > 0;

                if (!name || !price || !size || !inventory) {
                    showStatus('Please fill in all required fields (Name, Price, Size, Inventory).', 'danger');
                    return;
                }

                // For new trophy (not editing), require at least one image
                if (!currentEditingId && imageFiles.length === 0) {
                    showStatus('Please upload at least one image for the trophy.', 'danger');
                    return;
                }

                // For existing trophy, must have at least one image total (existing + new)
                if (currentEditingId && imageFiles.length === 0 && !hasExistingImages) {
                    showStatus('Trophy must have at least one image. Please upload an image.', 'danger');
                    return;
                }

                // Create FormData
                const formData = new FormData(addForm);

                // Get new images and append to FormData
                const images = trophyImagesInput.files;
                for (let i = 0; i < images.length; i++) {
                    formData.append('images', images[i]);
                }

                // For edit mode, pass existing images and delete list
                if (currentEditingId) {
                    console.log('ðŸ” DEBUG: Edit mode detected');
                    console.log('ðŸ” existingImages array:', existingImages);
                    console.log('ðŸ” existingImages length:', existingImages.length);
                    console.log('ðŸ” imagesToDelete:', imagesToDelete);

                    formData.append('existingImages', JSON.stringify(existingImages));
                    formData.append('imagesToDelete', JSON.stringify(imagesToDelete));
                    // Always append new images to existing ones during edit
                    // (never replace all images unless user explicitly deletes them)
                    formData.append('appendImages', 'true');

                    console.log('âœ… Sent to backend - appendImages: true, existingImages count:', existingImages.length);
                }

                try {
                    showStatus(currentEditingId ? 'Saving changes...' : 'Adding trophy...', 'info');
                    const method = currentEditingId ? 'PATCH' : 'POST';
                    const apiUrl = currentEditingId
                        ? `${getBackendUrl()}/api/trophies/${currentEditingId}`
                        : `${getBackendUrl()}/api/trophies`;

                    console.log('Request:', method, apiUrl);
                    console.log('=== FormData Entries ===');
                    console.log('New images files count:', images.length);
                    for (const [key, value] of formData.entries()) {
                        if (key === 'images') {
                            console.log(`  ${key}: [File] ${value.name || value}`);
                        } else {
                            console.log(`  ${key}: ${value}`);
                        }
                    }
                    console.log('========================');

                    const token = getToken();
                    const res = await fetch(apiUrl, {
                        method: method,
                        body: formData,
                        headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                        credentials: 'include'
                    });

                    const data = await res.json();
                    console.log('Response:', data);

                    if (res.ok && data.trophy) {
                        const msg = currentEditingId
                            ? `Trophy updated successfully!`
                            : `Trophy added successfully! ID: ${data.trophy._id}`;
                        showStatus(msg, 'success');
                        addForm.reset();
                        imagePreview.innerHTML = '';
                        cancelEdit();
                        loadTrophyList();
                    } else {
                        showStatus(data.error || data.message || 'Failed to save trophy.', 'danger');
                    }
                } catch (err) {
                    showStatus('Error: ' + err.message, 'danger');
                    console.error('Trophy save error:', err);
                }
            });
        }

        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `alert alert-${type}`;
            statusDiv.classList.remove('d-none');

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('d-none');
                }, 5000);
            }
        }

        function getBackendUrl() {
            // Auto-detect backend URL
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            return 'https://kg7kg65ok2hvfox6l4gtniqhsi0ckmox.lambda-url.ap-south-1.on.aws';
        }

        function getToken() {
            // Get JWT token from sessionStorage or localStorage
            const token = sessionStorage.getItem('staffToken') || localStorage.getItem('staffToken');
            return token;
        }
    </script>
</body>

</html>