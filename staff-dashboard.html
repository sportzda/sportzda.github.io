<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Staff Dashboard â€” DA SPORTZ</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- Fonts & Bootstrap -->
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --primary: #0f1723;
            --accent: #ff5900;
            --accent-2: #00d4aa;
            --muted: #6b7280;
            --card-bg: #ffffff;
            --primary-color: #1f1f1f;
            --accent-color: #ff5900;
            --nav-hover: #ff5900;
            --bg-light: #f4f4f4;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Barlow', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: #f5f7fb;
            color: var(--primary);
            font-size: 1rem;
            line-height: 1.6;
            background-color: var(--bg-light);
            color: var(--primary-color);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a {
            text-decoration: none;
        }

        .top-bar {
            background: var(--primary);
            color: #fff;
            font-size: .95rem;
        }

        .top-bar a {
            color: #fff;
        }

        .navbar-brand {
            font-weight: 800;
            letter-spacing: 1px;
            font-size: 1.6rem;
        }

        .nav-link {
            color: var(--muted);
        }

        .dropdown-menu {
            --bs-dropdown-link-hover-bg: #ff59001a;
            --bs-dropdown-link-active-bg: #ff5900;
            --bs-dropdown-link-active-color: #fff;
        }

        .nav-link:focus,
        .nav-link:hover {
            color: var(--accent-color);
        }

        .nav-link {
            position: relative;
        }

        .nav-link::before {
            content: '';
            display: block;
            height: 2px;
            width: 0;
            background: var(--nav-hover);
            transition: width 0.3s ease-in-out;
            position: absolute;
            bottom: -6px;
            left: 0;
        }

        .nav-link:hover::before,
        .nav-link.active::before {
            width: 100%;
        }

        .offer-bar {
            background-color: var(--accent-color);
            color: #fff;
            font-weight: 500;
            font-size: 0.95rem;
        }

        nav.navbar {
            background: #ffffff;
            border-bottom: 1px solid #e1e1e1;
            font-family: 'Barlow', sans-serif;
            font-size: 0.95rem;
        }

        .navbar-brand {
            font-family: 'Barlow', sans-serif;
            font-weight: 800;
            font-size: 2rem;
            letter-spacing: 1px;
            color: var(--primary-color) !important;
        }

        .nav-link {
            font-weight: 500;
            color: var(--primary-color) !important;
            position: relative;
        }

        footer {
            background: var(--primary-color);
            color: #fff;
            padding: 2rem 0 1rem 0;
        }

        footer a {
            color: var(--accent-color);
        }

        .whatsapp-float {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #25d366;
            color: #fff;
            box-shadow: 0 8px 30px rgba(10, 10, 10, 0.15);
            z-index: 1200;
        }

        /* Login Modal Styles */
        #loginModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        #loginModal.show {
            display: flex;
        }

        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        /* Order Details Modal */
        #orderDetailsModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            overflow-y: auto;
        }

        #orderDetailsModal.show {
            display: flex;
        }

        .order-details-box {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            margin: 2rem auto;
        }

        .close-details {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            transition: color 0.2s;
            z-index: 1;
        }

        .close-details:hover {
            color: var(--accent-color);
        }

        .order-details-header {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .order-details-section {
            margin-bottom: 1.5rem;
        }

        .order-details-section h4 {
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--accent-color);
            padding-left: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--muted);
            font-weight: 500;
        }

        .detail-value {
            color: var(--primary-color);
            font-weight: 600;
            text-align: right;
        }

        .item-detail-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .item-detail-card:last-child {
            margin-bottom: 0;
        }

        /* Loading Overlay */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        #loadingOverlay.show {
            display: flex;
        }

        .loading-overlay-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .loading-overlay-content .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--accent-color);
        }

        .loading-overlay-content p {
            margin-top: 1rem;
            margin-bottom: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .close-login {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--muted);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-login:hover {
            background: #f0f0f0;
            color: var(--primary-color);
        }

        .login-box h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .login-box .subtitle {
            color: var(--muted);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }

        .login-error.show {
            display: block;
        }

        .dashboard-content {
            display: none;
        }

        .dashboard-content.show {
            display: block;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast-notification {
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideIn 0.3s ease-out;
            font-size: 0.95rem;
        }

        .toast-notification.toast-error {
            background: #dc3545;
        }

        .toast-notification.toast-info {
            background: #17a2b8;
        }

        .toast-notification i {
            font-size: 1.2rem;
        }

        .toast-notification.fade-out {
            animation: slideOut 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Dashboard Specific Styles */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, #2a3f5f 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .service-menu {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .service-menu-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e1e1e1;
            background: white;
            border-radius: 8px;
            font-weight: 600;
            color: var(--primary-color);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        .service-menu-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }

        .service-menu-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .status-tabs {
            background: white;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .status-tabs .nav-tabs {
            border-bottom: none;
            padding: 1rem 1rem 0 1rem;
        }

        .status-tabs .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--muted);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .status-tabs .nav-tabs .nav-link:hover {
            color: var(--accent-color);
            border-bottom-color: rgba(255, 89, 0, 0.3);
        }

        .status-tabs .nav-tabs .nav-link.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: transparent;
        }

        .status-tabs .tab-content {
            padding: 1.5rem;
        }

        .order-card {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .order-card:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(255, 89, 0, 0.15);
            transform: translateY(-2px);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-id {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .order-date {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .customer-info {
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .customer-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .customer-phone {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .order-items {
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .item-chip {
            display: inline-block;
            background: #f8f9fa;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            border: 1px solid #e1e1e1;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .order-total {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.received {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-badge.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-badge.completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h4 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }

        .spinner-border {
            color: var(--accent-color);
        }

        .action-buttons {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }

        .btn-update-status {
            background: var(--accent-color);
            color: white;
            border: none;
        }

        .btn-update-status:hover {
            background: #e04800;
        }

        .btn-view-details {
            background: white;
            color: var(--primary-color);
            border: 1px solid #e1e1e1;
        }

        .btn-view-details:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Refresh button animation */
        .btn-refresh-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                font-size: 0.9rem;
            }

            .top-bar {
                font-size: 0.8rem;
                padding: 0.5rem 0 !important;
            }

            .top-bar .container {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .top-bar .d-flex {
                flex-direction: column;
                gap: 0.25rem !important;
            }

            .navbar-brand {
                font-size: 1.3rem;
            }

            .dashboard-header {
                padding: 1rem 0;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .dashboard-header p {
                font-size: 0.85rem;
            }

            .service-menu {
                padding: 1rem;
            }

            .service-menu h5 {
                font-size: 1rem;
            }

            .service-menu-btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 0.5rem;
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .status-tabs .nav-tabs {
                padding: 0.5rem;
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .status-tabs .nav-tabs::-webkit-scrollbar {
                display: none;
            }

            .status-tabs .nav-tabs .nav-link {
                padding: 0.6rem 1rem;
                margin-right: 0.25rem;
                font-size: 0.85rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .status-tabs .tab-content {
                padding: 1rem;
            }

            .order-card {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }

            .order-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .order-id {
                font-size: 1rem;
            }

            .order-date {
                font-size: 0.8rem;
            }

            .customer-info {
                text-align: left;
            }

            .customer-name {
                font-size: 0.95rem;
            }

            .customer-phone {
                font-size: 0.85rem;
            }

            .order-items {
                text-align: left;
            }

            .item-chip {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
                margin-right: 0.25rem;
                margin-bottom: 0.25rem;
                display: block;
                margin-bottom: 0.5rem;
            }

            .order-footer {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .order-total {
                font-size: 1rem;
            }

            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }

            .btn-action {
                width: 100%;
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
                justify-content: center;
            }

            .payment-method-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .payment-method-selector select {
                width: 100%;
            }

            .btn-update-payment {
                width: 100%;
            }

            .empty-state {
                padding: 2rem 1rem;
            }

            .empty-state h4 {
                font-size: 1.1rem;
            }

            .empty-state p {
                font-size: 0.9rem;
            }

            /* Toast notifications - adjust for mobile */
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast-notification {
                min-width: auto;
                max-width: 100%;
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }

            /* Login modal - better mobile view */
            .login-box {
                max-width: 90%;
                padding: 1.5rem;
            }

            .login-box h2 {
                font-size: 1.3rem;
            }

            /* Footer adjustments */
            footer {
                font-size: 0.85rem;
            }

            footer h5 {
                font-size: 1rem;
            }
        }

        /* Extra small devices (phones in portrait, less than 576px) */
        @media (max-width: 576px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .navbar-brand {
                font-size: 1.2rem;
            }

            .status-tabs .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .status-tabs .nav-tabs .nav-link .badge {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }

            .order-id {
                font-size: 0.95rem;
            }

            .item-chip {
                font-size: 0.75rem;
            }

            .btn-action {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 896px) and (orientation: landscape) {
            .dashboard-header {
                padding: 0.75rem 0;
            }

            .status-tabs .tab-content {
                max-height: 60vh;
                overflow-y: auto;
            }
        }

        /* Improve touch targets for mobile */
        @media (hover: none) and (pointer: coarse) {

            .btn-action,
            .service-menu-btn,
            .status-tabs .nav-link {
                min-height: 44px;
            }

            .order-card {
                cursor: default;
            }
        }
    </style>
</head>

<body>
    <!-- Offer Bar -->
    <div class="offer-bar text-center py-2">
        ðŸ”’ Staff Dashboard - Authorized Personnel Only
    </div>

    <!-- Top Bar -->
    <div class="top-bar py-2 border-bottom">
        <div class="container d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex align-items-center gap-3">
                <span><i class="bi bi-telephone"></i> +91-8800505769</span>
                <span><i class="bi bi-envelope"></i> contact@dasportz.com</span>
            </div>
            <div class="d-flex align-items-center gap-3 mt-2 mt-md-0">
                <span id="staffUsername" class="badge bg-light text-dark"><i class="bi bi-person-circle"></i>
                    Staff</span>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">DA SPORTZ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between align-items-center" id="navbarNav">
                <ul class="navbar-nav ms-auto d-flex align-items-center">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="bi bi-speedometer2"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="bi bi-house"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-overlay-content">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p id="loadingMessage">Fetching orders...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" role="dialog" aria-modal="true" aria-labelledby="orderDetailsTitle">
        <div class="order-details-box">
            <button id="closeDetailsBtn" class="close-details" title="Close">
                <i class="bi bi-x-lg"></i>
            </button>
            <div id="orderDetailsContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-box">
            <button id="closeLoginBtn" class="close-login" title="Close">
                <i class="bi bi-x-lg"></i>
            </button>

            <h2 class="text-center"><i class="bi bi-shield-lock"></i> Staff Login</h2>
            <p class="subtitle text-center">Access Staff Dashboard</p>

            <div id="loginError" class="login-error">
                <i class="bi bi-exclamation-triangle"></i> Invalid username or password
            </div>

            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn w-100" style="background: var(--accent-color); color: white;">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Content (hidden until authenticated) -->
    <div class="dashboard-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h1 class="h2 mb-2"><i class="bi bi-speedometer2"></i> Staff Dashboard</h1>
                        <p class="mb-0 opacity-75">Manage orders and track service status</p>
                    </div>
                    <div class="text-end d-flex align-items-center gap-3">
                        <div>
                            <div class="text-white-50 small">Last Updated</div>
                            <div class="fw-bold" id="lastUpdated">Loading...</div>
                        </div>
                        <button id="refreshBtn" class="btn btn-light btn-sm" onclick="handleRefresh()"
                            title="Refresh data">
                            <i class="bi bi-arrow-clockwise" id="refreshIcon"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="handleLogout()" title="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container pb-5">
            <!-- Service Selection Menu -->
            <div class="service-menu">
                <h5 class="mb-3"><i class="bi bi-list-ul"></i> Select Service</h5>
                <div class="d-flex flex-wrap gap-2">
                    <button class="service-menu-btn active" data-service="racket-stringing">
                        <i class="bi bi-bullseye"></i> Racket Stringing
                    </button>
                    <button class="service-menu-btn" data-service="bat-knocking">
                        <i class="bi bi-hammer"></i> Bat Knocking
                    </button>
                    <button id="openQRScanBtn" class="service-menu-btn"
                        style="background-color: #28a745; border-color: #28a745;">
                        <i class="bi bi-qr-code"></i> Scan QR
                    </button>
                </div>
            </div>

            <!-- Status Tabs -->
            <div class="status-tabs">
                <ul class="nav nav-tabs" id="statusTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="received-tab" data-bs-toggle="tab"
                            data-bs-target="#received" type="button" role="tab">
                            <i class="bi bi-inbox"></i> Received
                            <span class="badge bg-primary rounded-pill ms-2" id="receivedCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="in-progress-tab" data-bs-toggle="tab" data-bs-target="#in-progress"
                            type="button" role="tab">
                            <i class="bi bi-gear"></i> In Progress
                            <span class="badge bg-warning rounded-pill ms-2" id="inProgressCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed"
                            type="button" role="tab">
                            <i class="bi bi-check-circle"></i> Completed
                            <span class="badge bg-success rounded-pill ms-2" id="completedCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-payments-tab" data-bs-toggle="tab"
                            data-bs-target="#pending-payments" type="button" role="tab">
                            <i class="bi bi-cash-coin"></i> Pending Payments
                            <span class="badge bg-danger rounded-pill ms-2" id="pendingPaymentsCount">0</span>
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="statusTabContent">
                    <!-- Received Tab -->
                    <div class="tab-pane fade show active" id="received" role="tabpanel">
                        <div id="receivedContent"></div>
                    </div>

                    <!-- In Progress Tab -->
                    <div class="tab-pane fade" id="in-progress" role="tabpanel">
                        <div id="inProgressContent"></div>
                    </div>

                    <!-- Completed Tab -->
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                        <div id="completedContent"></div>
                    </div>

                    <!-- Pending Payments Tab -->
                    <div class="tab-pane fade" id="pending-payments" role="tabpanel">
                        <div id="pendingPaymentsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="mt-5">
        <div class="container">
            <div class="row text-center">
                <div class="col-md-4 mb-4">
                    <h5 class="text-uppercase">DA SPORTZ</h5>
                    <p>Your one-stop shop for premium sports gear. Trusted by players. Loved by champions.</p>
                </div>
                <div class="col-md-4 mb-4">
                    <h5 class="text-uppercase">Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="index.html#about">About Us</a></li>
                        <li><a href="index.html#contact">Contact</a></li>
                        <li><a href="terms.html">Terms of Service</a></li>
                        <li><a href="refund_cancellation.html">Refund & Cancellation</a></li>
                        <li><a href="https://g.co/kgs/n2Rg2j5" target="_blank">Google Reviews</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-4">
                    <h5 class="text-uppercase">Follow Us</h5>
                    <a href="https://www.instagram.com/da.sportz?igsh=MW5jZGNxamVhMm1vaA%3D%3D&utm_source=qr"
                        class="me-3"><i class="bi bi-instagram"></i></a>
                    <a href="mailto:contact@dasportz.com"><i class="bi bi-envelope"></i></a>
                </div>
            </div>
            <div class="text-center pt-3 border-top border-secondary">
                <small>&copy; 2025 DA SPORTZ. All Rights Reserved.</small>
            </div>
        </div>
    </footer>

    <!-- QR Code Scanning Modal -->
    <div id="qrScanModal"
        style="display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: flex-end; padding: 20px 0; overflow-y: auto;">
        <div
            style="background: white; border-radius: 12px 12px 0 0; width: 100%; max-width: 500px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; margin-top: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h5 style="margin: 0; font-weight: 700; font-size: 18px;"><i class="bi bi-qr-code"></i> Scan QR Code
                </h5>
                <button id="closeQRBtn"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>

            <!-- Bat/Racket Selection Toggle -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <button id="selectRacketBtn"
                    style="flex: 1; padding: 10px; background: #1e40af; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    <i class="bi bi-tennis"></i> Racket
                </button>
                <button id="selectBatBtn"
                    style="flex: 1; padding: 10px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    <i class="bi bi-baseball"></i> Cricket Bat
                </button>
            </div>

            <div style="margin-bottom: 15px;">
                <!-- Camera Section -->
                <div id="cameraSection" style="margin-bottom: 15px;">
                    <video id="qrVideo" autoplay playsinline muted
                        style="width: 100%; max-width: 400px; height: auto; aspect-ratio: 4/3; border-radius: 8px; background: #000; margin: 0 auto; display: block; margin-bottom: 10px; object-fit: cover;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div id="cameraStatus" style="text-align: center; color: #059669; font-size: 13px;">
                        <small>Position QR code in frame</small>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label id="listLabel"
                    style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px;">Select
                    Order & Racket:</label>
                <div id="unlinkedList"
                    style="border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto; background: #f9fafb;">
                    <div style="padding: 15px; text-align: center; color: #9ca3af; font-size: 13px;">
                        <small>Scan a QR code to see available items</small>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 8px;">
                <button id="scanAgainBtn"
                    style="flex: 1; padding: 10px; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: none; font-size: 13px;">
                    <i class="bi bi-camera-fill"></i> Scan Again
                </button>
                <button id="linkQRBtn" disabled
                    style="flex: 1; padding: 10px; background: #1e40af; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    <i class="bi bi-link-45deg"></i> Link QR
                </button>
                <button id="closeQRBtn"
                    style="flex: 1; padding: 10px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <script>
        // Dashboard Application
        document.addEventListener('DOMContentLoaded', function () {
            // Configuration - Auto-detect environment
            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3000'
                : 'https://kg7kg65ok2hvfox6l4gtniqhsi0ckmox.lambda-url.ap-south-1.on.aws'; // Update with your AWS Lambda API Gateway URL
            let authToken = null;
            let isAuthenticated = false;
            let currentService = 'racket-stringing';
            let currentStatus = 'received';

            // Loading Overlay Helper Functions
            function showLoadingOverlay(message = 'Processing...') {
                const loadingOverlay = document.getElementById('loadingOverlay');
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) loadingMessage.textContent = message;
                if (loadingOverlay) loadingOverlay.classList.add('show');
            }

            function hideLoadingOverlay() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.remove('show');
            }

            // DOM elements
            const loginModal = document.getElementById('loginModal');
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('loginError');
            const closeLoginBtn = document.getElementById('closeLoginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const dashboardContent = document.querySelector('.dashboard-content');
            const staffUsername = document.getElementById('staffUsername');

            // Scroll lock functions
            let scrollPosition = 0;

            function lockScroll() {
                scrollPosition = window.pageYOffset;
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollPosition}px`;
                document.body.style.width = '100%';
                document.body.classList.add('modal-open');
            }

            function unlockScroll() {
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('position');
                document.body.style.removeProperty('top');
                document.body.style.removeProperty('width');
                document.body.classList.remove('modal-open');
                window.scrollTo(0, scrollPosition);
            }

            // Check authentication on page load
            async function checkAuth() {
                authToken = sessionStorage.getItem('staffAuthToken');
                const username = sessionStorage.getItem('staffUser');

                if (authToken) {
                    // Verify token with backend
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/staff/verify`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });

                        if (response.ok) {
                            isAuthenticated = true;
                            showDashboard(username);
                            return true;
                        } else {
                            // Token invalid or expired, clear and show login
                            console.log('Token verification failed with status:', response.status);
                            sessionStorage.removeItem('staffAuthToken');
                            sessionStorage.removeItem('staffUser');
                            authToken = null;
                        }
                    } catch (err) {
                        console.error('Token verification failed:', err);
                        sessionStorage.removeItem('staffAuthToken');
                        sessionStorage.removeItem('staffUser');
                        authToken = null;
                    }
                } else {
                    console.log('No auth token found in sessionStorage');
                }

                showLoginModal();
                return false;
            }

            // Show login modal
            function showLoginModal() {
                loginModal.classList.add('show');
                lockScroll();
            }

            // Hide login modal
            function hideLoginModal() {
                loginModal.classList.remove('show');
                unlockScroll();
            }

            // Toast notification system
            function showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast-notification toast-${type}`;

                const icon = type === 'success' ? 'check-circle-fill' :
                    type === 'error' ? 'exclamation-circle-fill' :
                        'info-circle-fill';

                // Create elements safely to prevent XSS
                const iconElement = document.createElement('i');
                iconElement.className = `bi bi-${icon}`;

                const messageSpan = document.createElement('span');
                messageSpan.textContent = message; // Use textContent to escape HTML

                toast.appendChild(iconElement);
                toast.appendChild(messageSpan);

                container.appendChild(toast);

                // Auto-dismiss after 4 seconds
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    setTimeout(() => {
                        container.removeChild(toast);
                    }, 300);
                }, 4000);
            }

            // Show dashboard
            function showDashboard(username) {
                hideLoginModal();
                dashboardContent.classList.add('show');
                // Safely set username to prevent XSS - create elements separately
                staffUsername.innerHTML = '<i class="bi bi-person-circle"></i> ';
                const usernameText = document.createTextNode(username || 'Staff');
                staffUsername.appendChild(usernameText);
                updateLastUpdated();
                loadDashboardData();
            }

            // Login form submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                // Disable submit button during login
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Logging in...';

                try {
                    const response = await fetch(`${API_BASE_URL}/api/staff/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Store token and user info
                        authToken = data.token;
                        sessionStorage.setItem('staffAuthToken', data.token);
                        sessionStorage.setItem('staffUser', username);
                        isAuthenticated = true;
                        loginError.classList.remove('show');
                        showDashboard(username);
                    } else {
                        // Show error message
                        loginError.textContent = data.message || 'Invalid username or password';
                        loginError.classList.add('show');
                        document.getElementById('password').value = '';
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    loginError.textContent = 'Login failed. Please check your connection and try again.';
                    loginError.classList.add('show');
                } finally {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Login';
                }
            });

            // Close login button
            closeLoginBtn.addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // Logout button
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    sessionStorage.removeItem('staffAuthToken');
                    sessionStorage.removeItem('staffUser');
                    authToken = null;
                    isAuthenticated = false;
                    window.location.href = 'index.html';
                }
            });

            // Service menu buttons
            const serviceButtons = document.querySelectorAll('.service-menu-btn:not(#openQRScanBtn)');
            serviceButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    serviceButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentService = btn.dataset.service;
                    loadDashboardData();
                });
            });

            // Tab click handlers
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.bsTarget.replace('#', '');
                    currentStatus = targetId;
                    loadTabData(targetId);
                });
            });

            // Update last updated timestamp
            function updateLastUpdated() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                document.getElementById('lastUpdated').textContent = timeString;
            }

            // Cache for all orders
            let allOrdersCache = [];
            let isLoading = false; // Global loading state

            // Show/hide loading overlay
            function showLoadingOverlay(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const messageEl = document.getElementById('loadingMessage');
                if (overlay && messageEl) {
                    messageEl.textContent = message;
                    overlay.classList.add('show');
                }
            }

            function hideLoadingOverlay() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
            }

            // Load dashboard data - fetch all orders once
            async function loadDashboardData() {
                if (isLoading) return; // Prevent multiple simultaneous loads
                isLoading = true;

                updateLastUpdated();
                showLoadingOverlay('Fetching orders...');

                try {
                    // Fetch all orders for current service
                    await fetchAllOrders();

                    // Populate all tabs from cache
                    populateAllTabsFromCache();
                } finally {
                    hideLoadingOverlay();
                    isLoading = false;
                }
            }

            // Fetch all orders from API (called once per service)
            async function fetchAllOrders() {
                try {
                    const params = new URLSearchParams({
                        serviceType: currentService,
                        limit: 100,
                        sort: 'desc'
                    });

                    const response = await fetch(`${API_BASE_URL}/api/orders?${params.toString()}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        allOrdersCache = data.orders || [];
                        console.log(`Fetched ${allOrdersCache.length} orders for ${currentService}`);
                    } else if (response.status === 401) {
                        alert('Your session has expired. Please login again.');
                        sessionStorage.removeItem('staffAuthToken');
                        sessionStorage.removeItem('staffUser');
                        window.location.reload();
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (err) {
                    console.error('Failed to fetch orders:', err);
                    allOrdersCache = [];
                }
            }

            // Populate all tabs from cached orders
            function populateAllTabsFromCache() {
                populateTabFromCache('received', 0);
                populateTabFromCache('in-progress', 1);
                populateTabFromCache('completed', 2);
                loadPendingPayments(); // Load pending payments separately
            }

            // Populate a single tab by filtering cached orders by racket/bat status
            function populateTabFromCache(tabName, statusValue) {
                const contentIdMap = {
                    'received': 'receivedContent',
                    'in-progress': 'inProgressContent',
                    'completed': 'completedContent'
                };

                const contentId = contentIdMap[tabName];
                const contentEl = document.getElementById(contentId);

                if (!contentEl) {
                    console.error(`Content element not found for status: ${tabName}`);
                    return;
                }

                // Filter orders by item status (racket or bat)
                const filteredOrders = filterOrdersByItemStatus(allOrdersCache, statusValue, currentService);

                // Don't transform - renderOrders now works directly with raw order objects
                renderOrders(contentEl, filteredOrders, tabName);
                updateSingleBadgeCount(tabName, filteredOrders.length);
            }

            // Filter orders by individual racket/bat status
            function filterOrdersByItemStatus(orders, statusValue, service) {
                const filtered = [];

                for (const order of orders) {
                    if (service === 'racket-stringing' && order.racketDetails) {
                        // Filter rackets with matching status (default to 0 if status is missing)
                        const matchingRackets = order.racketDetails.filter(r => {
                            const itemStatus = r.status !== undefined && r.status !== null ? Number(r.status) : 0;
                            return itemStatus === statusValue;
                        });

                        if (matchingRackets.length > 0) {
                            // Create a copy of order with only matching rackets
                            filtered.push({
                                ...order,
                                racketDetails: matchingRackets
                            });
                        }
                    } else if (service === 'bat-knocking' && order.batDetails) {
                        // Filter bats with matching status (default to 0 if status is missing)
                        const matchingBats = order.batDetails.filter(b => {
                            const itemStatus = b.status !== undefined && b.status !== null ? Number(b.status) : 0;
                            return itemStatus === statusValue;
                        });

                        if (matchingBats.length > 0) {
                            // Create a copy of order with only matching bats
                            filtered.push({
                                ...order,
                                batDetails: matchingBats
                            });
                        }
                    }
                }

                return filtered;
            }

            // Load tab data from API
            async function loadTabData(status) {
                const statusMap = {
                    'received': 0,
                    'in-progress': 1,
                    'completed': 2
                };

                const statusValue = statusMap[status];
                populateTabFromCache(status, statusValue);
            }

            // Format date to include time
            function formatDateTime(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                // Check if date is valid
                if (isNaN(date.getTime())) return 'N/A';

                // Format date as "2 Dec"
                const day = date.getDate();
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = monthNames[date.getMonth()];

                // Format time in 12-hour format with AM/PM
                let hours = date.getHours();
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 should be 12

                return `${day} ${month}, ${hours}:${minutes} ${ampm}`;
            }

            // Format payment method for display
            function formatPaymentMethod(method) {
                if (!method || method === 'N/A') return 'N/A';
                if (method.toLowerCase() === 'online') return 'Zoho';
                return method;
            }

            // Transform API orders to display format
            function transformOrdersForDisplay(orders, service) {
                return orders.map(order => {
                    const items = [];

                    if (service === 'racket-stringing' && order.racketDetails) {
                        order.racketDetails.forEach(racket => {
                            items.push({
                                name: racket.string,
                                tension: `${racket.tension} lbs`,
                                qty: racket.qty || 1
                            });
                        });
                    } else if (service === 'bat-knocking' && order.batDetails) {
                        order.batDetails.forEach(bat => {
                            items.push({
                                name: bat.batModel || 'Cricket Bat',
                                package: `${bat.ballPackage || bat.package} balls`,
                                threading: bat.threading || bat.threadingType || 'none'
                            });
                        });
                    }

                    return {
                        orderId: order.orderId,
                        customerName: order.customerName,
                        phone: order.phone,
                        date: formatDateTime(order.createdAt || order.date),
                        items: items,
                        total: order.payment?.finalAmount || order.totalAmount || 0,
                        paymentStatus: order.paymentStatus === 'paid' ? 'Paid' : 'Pending',
                        paymentMethod: formatPaymentMethod(order.paymentMethod || 'N/A'),
                        store: order.store
                    };
                });
            }

            // Get mock data (fallback - for testing without backend)
            function getMockData(service, status) {
                // Mock data for demonstration
                const racketOrders = {
                    received: [
                        {
                            orderId: 'DA_1234567890',
                            customerName: 'Rahul Sharma',
                            phone: '9876543210',
                            date: '02-12-2025 10:30',
                            items: [
                                { name: 'Yonex BG 65', tension: '26 lbs', qty: 1 },
                                { name: 'Yonex BG 80', tension: '28 lbs', qty: 1 }
                            ],
                            total: 1250,
                            paymentStatus: 'Paid',
                            paymentMethod: 'BharatPe',
                            store: 'Gaur City 1'
                        },
                        {
                            orderId: 'DA_1234567891',
                            customerName: 'Priya Patel',
                            phone: '9876543211',
                            date: '02-12-2025 11:15',
                            items: [
                                { name: 'Li-Ning NS95', tension: '27 lbs', qty: 1 }
                            ],
                            total: 850,
                            paymentStatus: 'Pending',
                            paymentMethod: 'Cash',
                            store: 'Noida'
                        }
                    ],
                    'in-progress': [
                        {
                            orderId: 'DA_1234567892',
                            customerName: 'Amit Kumar',
                            phone: '9876543212',
                            date: '01-12-2025 14:20',
                            items: [
                                { name: 'Yonex Aerobite', tension: '25 lbs', qty: 2 }
                            ],
                            total: 1800,
                            paymentStatus: 'Paid',
                            paymentMethod: 'Zoho',
                            store: 'Gaur City 1'
                        }
                    ],
                    completed: [
                        {
                            orderId: 'DA_1234567893',
                            customerName: 'Sneha Singh',
                            phone: '9876543213',
                            date: '30-11-2025 09:45',
                            items: [
                                { name: 'Hundred Pro', tension: '24 lbs', qty: 1 }
                            ],
                            total: 480,
                            paymentStatus: 'Paid',
                            paymentMethod: 'AX',
                            store: 'Gaur City 1'
                        }
                    ]
                };

                const batOrders = {
                    received: [
                        {
                            orderId: 'DA_1234567894',
                            customerName: 'Vikas Gupta',
                            phone: '9876543214',
                            date: '02-12-2025 13:00',
                            items: [
                                { name: 'MRF Grand', package: '15000 balls', threading: 'both' }
                            ],
                            total: 1250,
                            paymentStatus: 'Paid',
                            paymentMethod: 'Cash',
                            store: 'Gaur City 1'
                        }
                    ],
                    'in-progress': [
                        {
                            orderId: 'DA_1234567895',
                            customerName: 'Rohit Verma',
                            phone: '9876543215',
                            date: '01-12-2025 16:30',
                            items: [
                                { name: 'SS Kashmir Willow', package: '20000 balls', threading: 'top' }
                            ],
                            total: 1100,
                            paymentStatus: 'Paid',
                            paymentMethod: 'BharatPe',
                            store: 'Noida'
                        }
                    ],
                    completed: [
                        {
                            orderId: 'DA_1234567896',
                            customerName: 'Arun Mehta',
                            phone: '9876543216',
                            date: '29-11-2025 15:00',
                            items: [
                                { name: 'SG English Willow', package: '30000 balls', threading: 'both' }
                            ],
                            total: 2000,
                            paymentStatus: 'Paid',
                            store: 'Gaur City 1'
                        }
                    ]
                };

                const data = service === 'racket-stringing' ? racketOrders : batOrders;
                return data[status] || [];
            }

            // Render orders in the tab
            // Now render one card per racket (or bat) so each item shows its own action button and details.
            function renderOrders(container, orders, status) {
                if (orders.length === 0) {
                    const serviceName = currentService ? currentService.replace('-', ' ') : 'service';
                    const statusName = status ? status.replace('-', ' ') : 'pending';
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <h4>No Orders Found</h4>
                            <p>There are no ${statusName} orders for ${serviceName}.</p>
                        </div>
                    `;
                    return;
                }

                const statusClass = status === 'received' ? 'received' : status === 'in-progress' ? 'in-progress' : 'completed';
                const statusText = status === 'received' ? 'Received' : status === 'in-progress' ? 'In Progress' : 'Completed';

                // Build cards per item (racket or bat) so it's clear which item's status is being changed
                const cards = [];

                orders.forEach(order => {
                    // For racket-stringing show each racket separately
                    if (currentService === 'racket-stringing' && order.racketDetails) {
                        order.racketDetails.forEach(racket => {
                            const racketName = racket.racketName || 'Racket';
                            const stringName = racket.string || '-';
                            const tension = racket.tension ? `${racket.tension} lbs` : '-';
                            const qty = racket.qty || 1;
                            // For B2B customers, use cost (discounted price). Otherwise use price (or cost if no price)
                            const racketPricePerUnit = racket.cost !== undefined ? racket.cost : (racket.price || 0);
                            const racketPrice = racketPricePerUnit * qty;

                            cards.push(`
                                <div class="order-card">
                                    <div class="order-card-header">
                                        <div>
                                            <div class="order-id">${order.orderId}</div>
                                            <div class="order-date"><i class="bi bi-calendar"></i> ${new Date(order.createdAt).toLocaleString()}</div>
                                        </div>
                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="customer-info">
                                        <div class="customer-name"><i class="bi bi-person"></i> ${order.customerName}</div>
                                        <div class="customer-phone"><i class="bi bi-telephone"></i> ${order.phone}</div>
                                        <div class="customer-phone"><i class="bi bi-shop"></i> ${order.store}</div>
                                    </div>
                                    <div class="order-items">
                                        <div class="item-card">
                                            <div class="item-title">${racketName}</div>
                                            <div class="item-meta small text-muted">${stringName} â€¢ ${tension} â€¢ Qty: ${qty}</div>
                                        </div>
                                    </div>
                                    <div class="order-footer">
                                        <div class="order-total">
                                            <div><strong>Cost:</strong> â‚¹${racketPrice}</div>
                                            <span class="small ${order.paymentStatus === 'Paid' ? 'text-success' : 'text-warning'}">(${order.paymentStatus === 'paid' ? 'Paid' : 'Pending'})</span>
                                            <br>
                                            <span class="small text-muted">
                                                <i class="bi ${order.paymentMethod === 'Cash' || order.paymentMethod === 'Pay At Outlet' ? 'bi-cash-coin' : order.paymentMethod === 'Zoho' ? 'bi-globe' : 'bi-credit-card'}"></i>
                                                ${order.paymentMethod}
                                            </span>
                                        </div>
                                        <div class="action-buttons">
                                            ${status !== 'completed' ? `
                                                <button class="btn btn-action btn-update-status" onclick="updateOrderStatus('${order.orderId}', '${status}', '${racket.id}')">
                                                    <i class="bi bi-arrow-right-circle"></i> ${status === 'received' ? (currentService === 'racket-stringing' ? 'Start Stringing' : 'Start Knocking') : 'Mark Complete'}
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-action btn-view-details" onclick="viewOrderDetails('${order.orderId}')">
                                                <i class="bi bi-eye"></i> View Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `);
                        });
                    } else if (currentService === 'bat-knocking' && order.batDetails) {
                        order.batDetails.forEach(bat => {
                            const name = bat.batModel || 'Cricket Bat';
                            const threading = bat.threading || bat.threadingType || 'none';
                            // For B2B customers, use cost (discounted price). Otherwise use price (or cost if no price)
                            const batPrice = bat.cost !== undefined ? bat.cost : (bat.price || 0);

                            cards.push(`
                                <div class="order-card">
                                    <div class="order-card-header">
                                        <div>
                                            <div class="order-id">${order.orderId}</div>
                                            <div class="order-date"><i class="bi bi-calendar"></i> ${new Date(order.createdAt).toLocaleString()}</div>
                                        </div>
                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="customer-info">
                                        <div class="customer-name"><i class="bi bi-person"></i> ${order.customerName}</div>
                                        <div class="customer-phone"><i class="bi bi-telephone"></i> ${order.phone}</div>
                                        <div class="customer-phone"><i class="bi bi-shop"></i> ${order.store}</div>
                                    </div>
                                    <div class="order-items">
                                        <div class="item-card">
                                            <div class="item-title">${name}</div>
                                            <div class="item-meta small text-muted">${threading && threading !== 'none' ? 'Threading ' + threading : ''}</div>
                                        </div>
                                    </div>
                                    <div class="order-footer">
                                        <div class="order-total">
                                            <div><strong>Cost:</strong> â‚¹${batPrice}</div>
                                            <span class="small ${order.paymentStatus === 'Paid' ? 'text-success' : 'text-warning'}">(${order.paymentStatus === 'paid' ? 'Paid' : 'Pending'})</span>
                                            <br>
                                            <span class="small text-muted">
                                                <i class="bi ${order.paymentMethod === 'Cash' || order.paymentMethod === 'Pay At Outlet' ? 'bi-cash-coin' : order.paymentMethod === 'Zoho' ? 'bi-globe' : 'bi-credit-card'}"></i>
                                                ${order.paymentMethod}
                                            </span>
                                        </div>
                                        <div class="action-buttons">
                                            ${status !== 'completed' ? `
                                                <button class="btn btn-action btn-update-status" onclick="updateOrderStatus('${order.orderId}', '${status}', '${bat.id}')">
                                                    <i class="bi bi-arrow-right-circle"></i> ${status === 'received' ? 'Start Knocking' : 'Mark Complete'}
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-action btn-view-details" onclick="viewOrderDetails('${order.orderId}')">
                                                <i class="bi bi-eye"></i> View Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `);
                        });
                    }
                });

                container.innerHTML = cards.join('');
            }

            // Update a single badge count
            function updateSingleBadgeCount(status, count) {
                const badgeIdMap = {
                    'received': 'receivedCount',
                    'in-progress': 'inProgressCount',
                    'completed': 'completedCount'
                };
                const badgeId = badgeIdMap[status];
                if (badgeId) {
                    const badgeEl = document.getElementById(badgeId);
                    if (badgeEl) {
                        badgeEl.textContent = count;
                    }
                }
            }

            // Load pending payments orders (Pay At Outlet with pending payment status)
            async function loadPendingPayments() {
                const contentEl = document.getElementById('pendingPaymentsContent');
                if (!contentEl) {
                    console.error('Pending payments content element not found');
                    return;
                }

                try {
                    // Fetch orders with Pay At Outlet payment method
                    const params = new URLSearchParams({
                        paymentMethod: 'Pay At Outlet',
                        serviceType: currentService,
                        limit: 100,
                        sort: 'desc'
                    });

                    const response = await fetch(`${API_BASE_URL}/api/orders?${params.toString()}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const pendingOrders = data.orders || [];
                        console.log(`Fetched ${pendingOrders.length} pending payment orders`);

                        renderPendingPayments(contentEl, pendingOrders);
                        updatePendingPaymentsCount(pendingOrders.length);
                    } else if (response.status === 401) {
                        alert('Your session has expired. Please login again.');
                        sessionStorage.removeItem('staffAuthToken');
                        sessionStorage.removeItem('staffUser');
                        window.location.reload();
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (err) {
                    console.error('Failed to fetch pending payments:', err);
                    contentEl.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h4>Failed to Load</h4>
                            <p>Could not load pending payments. Please try again.</p>
                        </div>
                    `;
                }
            }

            // Render pending payments orders
            function renderPendingPayments(container, orders) {
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-check-circle"></i>
                            <h4>All Payments Collected!</h4>
                            <p>There are no pending payments for ${currentService.replace('-', ' ')}.</p>
                        </div>
                    `;
                    return;
                }

                const ordersHtml = orders.map(order => {
                    const items = currentService === 'racket-stringing'
                        ? (order.racketDetails || []).map(r => ({
                            racketName: r.racketName || 'Racket',
                            stringName: r.string || 'Unknown',
                            tension: r.tension || '-',
                            qty: r.qty || 1,
                            id: r.id
                        }))
                        : (order.batDetails || []).map(b => ({
                            name: b.batModel || 'Unknown',
                            package: b.ballPackage || b.package || '-',
                            threading: b.threadingType || b.threading || '',
                            id: b.id
                        }));

                    return `
                        <div class="order-card">
                            <div class="order-card-header">
                                <div>
                                    <div class="order-id">${order.orderId}</div>
                                    <div class="order-date">
                                        <i class="bi bi-calendar"></i> ${new Date(order.createdAt).toLocaleString('en-IN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                                    </div>
                                </div>
                                <span class="status-badge" style="background: #fff3cd; color: #856404;">
                                    <i class="bi bi-cash-coin"></i> Pay At Outlet
                                </span>
                            </div>
                            <div class="customer-info">
                                <div class="customer-name">
                                    <i class="bi bi-person"></i> ${order.customerName}
                                </div>
                                <div class="customer-phone">
                                    <i class="bi bi-telephone"></i> ${order.phone}
                                </div>
                                <div class="customer-phone">
                                    <i class="bi bi-shop"></i> ${order.store}
                                </div>
                            </div>
                            <div class="order-items">
                                ${items.map(item => `
                                    <div class="item-chip">
                                        ${currentService === 'racket-stringing'
                            ? `${item.racketName}: ${item.stringName} - ${item.tension}`
                            : `${item.name} - ${item.package} ${item.threading ? `+ ${item.threading} threading` : ''}`
                        }
                                    </div>
                                `).join('')}
                            </div>
                            <div class="order-footer">
                                <div class="order-total">
                                    Total: â‚¹${order.totalAmount || 0}
                                    <span class="small text-warning">
                                        (Payment Pending)
                                    </span>
                                </div>
                                <div class="payment-method-selector">
                                    <select id="payment-method-${order.orderId}" class="form-select">
                                        <option value="">-- Select Payment Method --</option>
                                        <option value="Cash">Cash</option>
                                        <option value="AX" selected>Axis Bank (AX)</option>
                                    </select>
                                    <button class="btn-update-payment" onclick="updatePaymentMethod('${order.orderId}')">
                                        <i class="bi bi-check-circle"></i> Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = ordersHtml;
            }

            // Update pending payments count badge
            function updatePendingPaymentsCount(count) {
                const badgeEl = document.getElementById('pendingPaymentsCount');
                if (badgeEl) {
                    badgeEl.textContent = count;
                }
            }

            // Update payment method for an order
            window.updatePaymentMethod = async function (orderId) {
                const selectEl = document.getElementById(`payment-method-${orderId}`);
                if (!selectEl) {
                    showToast('Payment method selector not found', 'error');
                    return;
                }

                const paymentMethod = selectEl.value;
                if (!paymentMethod) {
                    showToast('Please select a payment method', 'error');
                    return;
                }

                // Map payment method to integer values expected by backend
                const paymentMethodMap = {
                    'Cash': 0,
                    'AX': 2
                };

                const paymentMethodValue = paymentMethodMap[paymentMethod];
                if (paymentMethodValue === undefined) {
                    showToast('Invalid payment method selected', 'error');
                    return;
                }

                if (!confirm(`Update payment method to ${paymentMethod}?`)) {
                    return;
                }

                showLoadingOverlay('Updating payment method...');

                try {
                    const response = await fetch(`${API_BASE_URL}/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            paymentMethod: paymentMethodValue,
                            discount_per_racket: 0  // No discount, just updating payment method
                        })
                    });

                    if (response.ok) {
                        console.log('Payment method updated successfully');
                        hideLoadingOverlay();
                        showToast(`Payment method updated to ${paymentMethod}!`);

                        // Reload pending payments to reflect changes
                        await loadPendingPayments();
                    } else if (response.status === 401) {
                        hideLoadingOverlay();
                        alert('Your session has expired. Please login again.');
                        sessionStorage.removeItem('staffAuthToken');
                        sessionStorage.removeItem('staffUser');
                        window.location.reload();
                    } else {
                        hideLoadingOverlay();
                        const error = await response.json();
                        console.error('Payment method update failed:', error);
                        showToast(`Failed to update: ${error.message || error.error || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    hideLoadingOverlay();
                    console.error('Error updating payment method:', err);
                    showToast('Failed to update payment method. Please check your connection.', 'error');
                }
            };

            // Handle refresh button click
            window.handleRefresh = async function () {
                if (isLoading) return;

                const refreshBtn = document.getElementById('refreshBtn');
                const refreshIcon = document.getElementById('refreshIcon');

                refreshBtn.disabled = true;
                refreshIcon.classList.add('btn-refresh-spin');

                try {
                    await loadDashboardData();
                } finally {
                    refreshBtn.disabled = false;
                    refreshIcon.classList.remove('btn-refresh-spin');
                }
            };

            // Global functions for button actions
            window.updateOrderStatus = async function (orderId, currentStatus, itemId = null) {
                const nextStatusValue = currentStatus === 'received' ? 1 : 2;
                const actionText = currentStatus === 'received'
                    ? (currentService === 'racket-stringing' ? 'start stringing' : 'start knocking')
                    : 'mark as complete';

                const message = `Are you sure you want to ${actionText} for this item?`;

                if (!confirm(message)) {
                    return;
                }

                showLoadingOverlay('Updating order status...');

                try {
                    // Get the order from cache
                    const order = allOrdersCache.find(o => o.orderId === orderId);
                    if (!order) {
                        hideLoadingOverlay();
                        alert('Order not found. Please refresh the page.');
                        return;
                    }

                    // If itemId is not provided, fallback to previous behaviour (first matching item)
                    let resolvedItemId = itemId;
                    if (!resolvedItemId) {
                        if (currentService === 'racket-stringing' && order.racketDetails) {
                            const statusMap = { 'received': 0, 'in-progress': 1 };
                            const currentStatusValue = statusMap[currentStatus];
                            const racket = order.racketDetails.find(r => (r.status !== undefined && r.status !== null ? Number(r.status) : 0) === currentStatusValue);
                            if (racket) resolvedItemId = racket.id;
                        } else if (currentService === 'bat-knocking' && order.batDetails) {
                            const statusMap = { 'received': 0, 'in-progress': 1 };
                            const currentStatusValue = statusMap[currentStatus];
                            const bat = order.batDetails.find(b => (b.status !== undefined && b.status !== null ? Number(b.status) : 0) === currentStatusValue);
                            if (bat) resolvedItemId = bat.id;
                        }
                    }

                    if (!resolvedItemId) {
                        hideLoadingOverlay();
                        showToast('Could not find item to update. Please refresh the page.', 'error');
                        return;
                    }

                    // Determine the correct endpoint
                    const endpoint = currentService === 'racket-stringing'
                        ? `/api/orders/${orderId}/status-by-racket/${resolvedItemId}`
                        : `/api/orders/${orderId}/status-by-bat/${resolvedItemId}`;

                    // Make authenticated API call
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ status: nextStatusValue })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Status updated successfully:', data);

                        // Reload dashboard data to reflect the change
                        await loadDashboardData();

                        hideLoadingOverlay();
                        // Show success message
                        showToast('Status updated successfully! WhatsApp notification sent to customer.');
                    } else if (response.status === 401) {
                        hideLoadingOverlay();
                        alert('Your session has expired. Please login again.');
                        sessionStorage.removeItem('staffAuthToken');
                        sessionStorage.removeItem('staffUser');
                        window.location.reload();
                    } else {
                        hideLoadingOverlay();
                        const error = await response.json();
                        console.error('Status update failed:', error);
                        showToast(`Failed to update status: ${error.message || error.error || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    hideLoadingOverlay();
                    console.error('Error updating status:', err);
                    showToast('Failed to update status. Please check your connection and try again.', 'error');
                }
            };

            window.viewOrderDetails = function (orderId) {
                // Find the order in cache
                const order = allOrdersCache.find(o => o.orderId === orderId);

                if (!order) {
                    showToast('Order not found', 'error');
                    return;
                }

                const modal = document.getElementById('orderDetailsModal');
                const content = document.getElementById('orderDetailsContent');

                // Clear previous content
                content.innerHTML = '';

                // Create header
                const header = document.createElement('div');
                header.className = 'order-details-header';

                const title = document.createElement('h3');
                title.innerHTML = '<i class="bi bi-receipt"></i> Order Details';

                const orderId_el = document.createElement('div');
                orderId_el.className = 'text-muted';
                orderId_el.textContent = orderId;

                header.appendChild(title);
                header.appendChild(orderId_el);
                content.appendChild(header);

                // Customer Information Section
                const customerSection = document.createElement('div');
                customerSection.className = 'order-details-section';

                const customerTitle = document.createElement('h4');
                customerTitle.innerHTML = '<i class="bi bi-person-circle"></i> Customer Information';
                customerSection.appendChild(customerTitle);

                const customerDetails = [
                    { label: 'Name', value: order.customerName },
                    { label: 'Phone', value: order.phone },
                    { label: 'Store', value: order.store || 'N/A' },
                    { label: 'Order Date', value: formatDateTime(order.createdAt || order.date) }
                ];

                customerDetails.forEach(detail => {
                    const row = document.createElement('div');
                    row.className = 'detail-row';

                    const label = document.createElement('span');
                    label.className = 'detail-label';
                    label.textContent = detail.label;

                    const value = document.createElement('span');
                    value.className = 'detail-value';
                    value.textContent = detail.value;

                    row.appendChild(label);
                    row.appendChild(value);
                    customerSection.appendChild(row);
                });

                content.appendChild(customerSection);

                // Items Section
                const itemsSection = document.createElement('div');
                itemsSection.className = 'order-details-section';

                const itemsTitle = document.createElement('h4');
                itemsTitle.innerHTML = '<i class="bi bi-list-ul"></i> Order Items';
                itemsSection.appendChild(itemsTitle);

                if (currentService === 'racket-stringing' && order.racketDetails) {
                    order.racketDetails.forEach((racket, idx) => {
                        const itemCard = document.createElement('div');
                        itemCard.className = 'item-detail-card';

                        const itemHeader = document.createElement('div');
                        itemHeader.style.fontWeight = '600';
                        itemHeader.style.marginBottom = '0.5rem';
                        itemHeader.textContent = `Racket ${idx + 1}`;
                        itemCard.appendChild(itemHeader);

                        const details = [
                            { label: 'Model', value: racket.racketName || 'N/A' },
                            { label: 'String', value: racket.string || 'N/A' },
                            { label: 'Tension', value: racket.tension ? `${racket.tension} lbs` : 'N/A' },
                            { label: 'Status', value: racket.status === 0 ? 'Received' : racket.status === 1 ? 'In Progress' : 'Completed' }
                        ];

                        details.forEach(detail => {
                            const row = document.createElement('div');
                            row.className = 'detail-row';
                            row.style.padding = '0.25rem 0';

                            const label = document.createElement('span');
                            label.className = 'detail-label';
                            label.textContent = detail.label;

                            const value = document.createElement('span');
                            value.className = 'detail-value';
                            value.textContent = detail.value;

                            row.appendChild(label);
                            row.appendChild(value);
                            itemCard.appendChild(row);
                        });

                        itemsSection.appendChild(itemCard);
                    });
                } else if (currentService === 'bat-knocking' && order.batDetails) {
                    order.batDetails.forEach((bat, idx) => {
                        const itemCard = document.createElement('div');
                        itemCard.className = 'item-detail-card';

                        const itemHeader = document.createElement('div');
                        itemHeader.style.fontWeight = '600';
                        itemHeader.style.marginBottom = '0.5rem';
                        itemHeader.textContent = `Bat ${idx + 1}`;
                        itemCard.appendChild(itemHeader);
                        const threadingValue = bat.threading || bat.threadingType || 'none';
                        const batCost = bat.cost !== undefined ? bat.cost : (bat.price || 0);
                        const details = [
                            { label: 'Model', value: bat.batModel || 'Cricket Bat' },
                            { label: 'Package', value: bat.ballPackage || bat.package ? `${bat.ballPackage || bat.package} balls` : 'N/A' },
                            { label: 'Cost', value: `â‚¹${batCost}` }
                        ];

                        // Only add threading detail if it's not 'none'
                        if (threadingValue !== 'none') {
                            details.push({ label: 'Threading', value: 'Threading ' + threadingValue });
                        }

                        details.push({ label: 'Status', value: bat.status === 0 ? 'Received' : bat.status === 1 ? 'In Progress' : 'Completed' });

                        details.forEach(detail => {
                            const row = document.createElement('div');
                            row.className = 'detail-row';
                            row.style.padding = '0.25rem 0';

                            const label = document.createElement('span');
                            label.className = 'detail-label';
                            label.textContent = detail.label;

                            const value = document.createElement('span');
                            value.className = 'detail-value';
                            value.textContent = detail.value;

                            row.appendChild(label);
                            row.appendChild(value);
                            itemCard.appendChild(row);
                        });

                        itemsSection.appendChild(itemCard);
                    });
                }

                content.appendChild(itemsSection);

                // Payment Section
                const paymentSection = document.createElement('div');
                paymentSection.className = 'order-details-section';

                const paymentTitle = document.createElement('h4');
                paymentTitle.innerHTML = '<i class="bi bi-credit-card"></i> Payment Information';
                paymentSection.appendChild(paymentTitle);

                const paymentDetails = [
                    { label: 'Payment Method', value: formatPaymentMethod(order.paymentMethod || 'N/A') },
                    { label: 'Payment Status', value: order.paymentStatus === 'paid' ? 'Paid' : 'Pending' }
                ];

                // Add discount details if coupon applied
                if (order.payment?.discount) {
                    if (order.payment.discount.couponCode) {
                        paymentDetails.push({ label: 'Coupon Code', value: order.payment.discount.couponCode });
                    }
                    if (order.payment.discount.couponDiscount) {
                        paymentDetails.push({ label: 'Discount Amount', value: `â‚¹${order.payment.discount.couponDiscount}` });
                    }
                }

                // Add pricing details
                if (order.payment?.originalAmount) {
                    paymentDetails.push({ label: 'Original Amount', value: `â‚¹${order.payment.originalAmount}` });
                }
                paymentDetails.push({ label: 'Final Amount', value: `â‚¹${order.payment?.finalAmount || order.totalAmount || 0}` });

                paymentDetails.forEach(detail => {
                    const row = document.createElement('div');
                    row.className = 'detail-row';

                    const label = document.createElement('span');
                    label.className = 'detail-label';
                    label.textContent = detail.label;

                    const value = document.createElement('span');
                    value.className = 'detail-value';
                    value.textContent = detail.value;

                    row.appendChild(label);
                    row.appendChild(value);
                    paymentSection.appendChild(row);
                });

                content.appendChild(paymentSection);

                // Show modal
                modal.classList.add('show');
                document.body.classList.add('modal-open');
            };

            // Close order details modal
            document.getElementById('closeDetailsBtn').addEventListener('click', function () {
                const modal = document.getElementById('orderDetailsModal');
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            });

            // Close on background click
            document.getElementById('orderDetailsModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('show');
                    document.body.classList.remove('modal-open');
                }
            });

            // Auto-refresh every 5 minutes (300000ms) - disabled by default, uncomment to enable
            // Uncomment the lines below to enable auto-refresh
            /*
            setInterval(() => {
                if (isAuthenticated) {
                    console.log('Auto-refresh: reloading current tab');
                    loadTabData(currentStatus);
                }
            }, 300000); // 5 minutes
            */

            // QR Scanning Functionality
            let qrScannedData = null;
            let cameraStream = null;
            let cameraActive = false;
            let qrScanInterval = null;
            let cachedUnlinkedRackets = []; // Cache unlinked rackets for instant display
            const qrScanBtn = document.getElementById('openQRScanBtn');
            const qrModal = document.getElementById('qrScanModal');
            const unlinkedList = document.getElementById('unlinkedList');
            const linkBtn = document.getElementById('linkQRBtn');
            const scanAgainBtn = document.getElementById('scanAgainBtn');
            const cameraSection = document.getElementById('cameraSection');
            const qrVideo = document.getElementById('qrVideo');
            const qrCanvas = document.getElementById('qrCanvas');
            const cameraStatus = document.getElementById('cameraStatus');
            const selectRacketBtn = document.getElementById('selectRacketBtn');
            const selectBatBtn = document.getElementById('selectBatBtn');
            const listLabel = document.getElementById('listLabel');
            let selectedItemId = null;
            let selectedItemType = null;
            let scanMode = 'racket'; // 'racket' or 'bat'
            let cachedUnlinkedBats = []; // Cache unlinked bats

            // Toggle between Racket and Bat mode
            selectRacketBtn.addEventListener('click', () => {
                scanMode = 'racket';
                selectRacketBtn.style.background = '#1e40af';
                selectRacketBtn.style.color = 'white';
                selectBatBtn.style.background = '#e5e7eb';
                selectBatBtn.style.color = '#333';
                listLabel.textContent = 'Select Racket:';
                // Don't show list until QR is scanned
                unlinkedList.innerHTML = '<div style="padding: 15px; text-align: center; color: #9ca3af; font-size: 13px;"><small>Scan a QR code to see available items</small></div>';
            });

            selectBatBtn.addEventListener('click', () => {
                scanMode = 'bat';
                selectBatBtn.style.background = '#1e40af';
                selectBatBtn.style.color = 'white';
                selectRacketBtn.style.background = '#e5e7eb';
                selectRacketBtn.style.color = '#333';
                listLabel.textContent = 'Select Cricket Bat:';
                // Don't show list until QR is scanned (even when switching to bat mode)
                unlinkedList.innerHTML = '<div style="padding: 15px; text-align: center; color: #9ca3af; font-size: 13px;"><small>Scan a QR code to see available items</small></div>';
            });

            // Prefetch unlinked orders on page load
            async function prefetchUnlinkedOrders() {
                try {
                    // Only prefetch if authenticated
                    if (!isAuthenticated || !authToken) {
                        console.log('[QR-PREFETCH] Skipping prefetch - not authenticated');
                        return;
                    }

                    console.log('[QR-PREFETCH] Prefetching unlinked orders...');
                    const response = await fetch(`${API_BASE_URL}/api/qr/unlinked/orders`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            cachedUnlinkedRackets = data.rackets || [];
                            console.log(`[QR-PREFETCH] Cached ${cachedUnlinkedRackets.length} unlinked rackets`);
                        }
                    }
                } catch (error) {
                    console.warn('[QR-PREFETCH] Failed to prefetch unlinked orders:', error);
                    // Continue anyway, will fetch on demand
                }
            }

            // Prefetch unlinked cricket bats on demand
            async function prefetchUnlinkedBats() {
                try {
                    console.log('[QR-PREFETCH] Prefetching unlinked cricket bats...');
                    // Show loading message immediately
                    unlinkedList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;"><i class="bi bi-hourglass-split" style="font-size: 32px; color: #d1d5db; margin-bottom: 10px; display: block;"></i><small>Loading cricket bats...</small></div>';

                    const response = await fetch(`${API_BASE_URL}/api/qr/unlinked/orders?mode=bat`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Reuse rackets array for cricket bats (same structure)
                            cachedUnlinkedBats = data.rackets || [];
                            console.log(`[QR-PREFETCH] Cached ${cachedUnlinkedBats.length} unlinked cricket bats`);
                            // Display the loaded cricket bats
                            displayCachedItems();
                        }
                    }
                } catch (error) {
                    console.warn('[QR-PREFETCH] Failed to prefetch unlinked cricket bats:', error);
                    // Show error message
                    unlinkedList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;"><small>Unable to load cricket bats</small></div>';
                }
            }

            // Display cached unlinked rackets/bats
            function displayCachedItems() {
                unlinkedList.innerHTML = '';
                selectedItemId = null;
                selectedItemType = null;
                linkBtn.disabled = true;
                linkBtn.style.opacity = '0.5';
                linkBtn.style.cursor = 'not-allowed';

                const cachedItems = scanMode === 'racket' ? cachedUnlinkedRackets : cachedUnlinkedBats;
                const itemType = scanMode === 'racket' ? 'racket' : 'cricket bat';

                if (cachedItems.length === 0) {
                    const plural = itemType === 'racket' ? 'rackets' : 'cricket bats';
                    unlinkedList.innerHTML = `<div style="padding: 20px; text-align: center; color: #9ca3af;"><i class="bi bi-hourglass-split" style="font-size: 32px; color: #d1d5db; margin-bottom: 10px; display: block;"></i><small>Loading ${plural}...</small></div>`;
                    return;
                }

                // Limit to 5 items max
                const itemsToShow = cachedItems.slice(0, 5);

                itemsToShow.forEach(item => {
                    // Both racket and bat modes use item.racket key for the data object
                    const itemData = item.racket || item;
                    const orderId = item.orderId || '';
                    const customerName = item.customerName || '';

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-group-item cursor-pointer';
                    itemDiv.style.cursor = 'pointer';
                    itemDiv.style.padding = '15px';
                    itemDiv.style.borderBottom = '1px solid #e5e7eb';

                    const orderInfo = orderId ? `<div class="small text-muted" style="margin-bottom: 8px;">${orderId} â€¢ ${customerName}</div>` : '';

                    let itemHTML = '';
                    if (scanMode === 'racket') {
                        itemHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    ${orderInfo}
                                    <strong>${itemData.racketName || 'Racket'}</strong>
                                    <div class="small text-muted">${itemData.string || 'Unknown String'} â€¢ ${itemData.tension ? itemData.tension + ' lbs' : '-'}</div>
                                </div>
                                <input type="radio" name="selectedItem" value="${itemData.id}" style="margin-top: 5px;">
                            </div>
                        `;
                    } else {
                        // For cricket bats, display in same format as rackets: Name â€¢ Package â€¢ Threading
                        const threadingValue = itemData.threading || 'none';
                        const packageValue = itemData.package ? `${itemData.package} balls` : '';
                        const threadingDisplay = threadingValue !== 'none' ? ` â€¢ ${threadingValue.charAt(0).toUpperCase() + threadingValue.slice(1)} Threading` : '';
                        const secondLine = `${packageValue}${threadingDisplay}`;

                        itemHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    ${orderInfo}
                                    <strong>${itemData.batModel || itemData.racketName || 'Cricket Bat'}</strong>
                                    <div class="small text-muted">${secondLine}</div>
                                </div>
                                <input type="radio" name="selectedItem" value="${itemData.id}" style="margin-top: 5px;">
                            </div>
                        `;
                    }

                    itemDiv.innerHTML = itemHTML;

                    itemDiv.addEventListener('click', () => {
                        document.querySelectorAll('input[name="selectedItem"]').forEach(r => r.checked = false);
                        itemDiv.querySelector('input[type="radio"]').checked = true;
                        selectedItemId = itemData.id;
                        selectedItemType = scanMode;
                        linkBtn.disabled = false;
                        linkBtn.style.opacity = '1';
                        linkBtn.style.cursor = 'pointer';
                    });

                    unlinkedList.appendChild(itemDiv);
                });
            }            // Start camera
            async function startCamera() {
                if (cameraActive) return;

                try {
                    cameraStatus.innerHTML = '<small style="color: #059669;">Requesting camera access...</small>';
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    qrVideo.srcObject = cameraStream;
                    cameraActive = true;

                    // Update status immediately after permission granted
                    cameraStatus.innerHTML = '<small style="color: #059669;">âœ“ Camera active - Position QR code in frame</small>';

                    // Wait for video to be ready
                    qrVideo.onloadedmetadata = () => {
                        qrVideo.play();
                        scanQRCode();
                    };
                } catch (error) {
                    console.error('Camera access error:', error);
                    let errorMsg = 'Camera access denied. Please check permissions.';
                    if (error.name === 'NotAllowedError') {
                        errorMsg = 'Camera access denied. Please allow camera permissions in your browser settings.';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg = 'No camera found on this device.';
                    } else if (error.name === 'NotReadableError') {
                        errorMsg = 'Camera is being used by another app. Please close other apps and try again.';
                    }
                    cameraStatus.innerHTML = `<small style="color: #dc2626;">${errorMsg}</small>`;
                    cameraActive = false;
                }
            }

            // Stop camera
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                cameraActive = false;
                if (qrScanInterval) {
                    clearInterval(qrScanInterval);
                }
                // Hide camera section and show Scan Again button after QR detection
                cameraSection.style.display = 'none';
                scanAgainBtn.style.display = 'block';
            }

            // Scan QR code from video
            function scanQRCode() {
                if (!cameraActive) return;

                qrScanInterval = setInterval(() => {
                    if (!qrVideo.paused && !qrVideo.ended && cameraActive) {
                        const canvasContext = qrCanvas.getContext('2d');
                        qrCanvas.width = qrVideo.videoWidth;
                        qrCanvas.height = qrVideo.videoHeight;
                        canvasContext.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);

                        const imageData = canvasContext.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code && code.data) {
                            let qrValue = code.data.trim();
                            console.log(`[QR-SCAN] Raw QR value: ${qrValue}`);

                            // Extract ID from URL if it's a full URL
                            if (qrValue.startsWith('http://') || qrValue.startsWith('https://')) {
                                try {
                                    // Remove protocol for simpler parsing
                                    let pathStr = qrValue.replace(/^https?:\/\//, '');
                                    // Get the last part after any slashes
                                    const parts = pathStr.split('/');
                                    qrValue = parts[parts.length - 1].trim();
                                } catch (e) {
                                    console.error('URL parsing error:', e);
                                    qrValue = qrValue.split('/').pop().trim();
                                }
                            }

                            console.log(`[QR-SCAN] Extracted QR value: ${qrValue}`);
                            qrScannedData = qrValue;
                            cameraStatus.innerHTML = `<small style="color: #059669;">âœ“ QR Code detected: ${qrValue}</small>`;
                            stopCamera();
                            // Enable Scan Again button when QR is successfully detected
                            scanAgainBtn.disabled = false;
                            scanAgainBtn.style.opacity = '1';
                            scanAgainBtn.style.cursor = 'pointer';
                            fetchAvailableRackets(qrValue);
                        }
                    }
                }, 300);
            }

            // Open QR Scanner Modal
            if (qrScanBtn) {
                qrScanBtn.addEventListener('click', async () => {
                    qrModal.style.display = 'flex';
                    qrScannedData = null;
                    selectedItemId = null;
                    selectedItemType = null;
                    scanMode = 'racket'; // Reset to racket mode
                    cameraStatus.innerHTML = '<small style="color: #059669;">Position QR code in frame</small>';

                    // INIT: Disable both buttons initially (Link QR already has disabled attribute, but ensure state)
                    linkBtn.disabled = true;
                    linkBtn.style.opacity = '0.5';
                    linkBtn.style.cursor = 'not-allowed';
                    scanAgainBtn.disabled = true;
                    scanAgainBtn.style.opacity = '0.5';
                    scanAgainBtn.style.cursor = 'not-allowed';

                    // Reset buttons to racket mode
                    selectRacketBtn.style.background = '#1e40af';
                    selectRacketBtn.style.color = 'white';
                    selectBatBtn.style.background = '#e5e7eb';
                    selectBatBtn.style.color = '#333';
                    listLabel.textContent = 'Select Racket:';

                    // Show camera section, hide Scan Again button on fresh open
                    cameraSection.style.display = 'block';
                    scanAgainBtn.style.display = 'none';

                    // Clear the list - only show after successful QR scan
                    unlinkedList.innerHTML = '<div style="padding: 15px; text-align: center; color: #9ca3af; font-size: 13px;"><small>Scan a QR code to see available items</small></div>';

                    startCamera();
                });
            }

            // Close QR Modal
            const allCloseButtons = document.querySelectorAll('#closeQRBtn');
            allCloseButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    qrModal.style.display = 'none';
                    stopCamera();
                });
            });

            // Scan Again button - restart camera for new QR scan
            if (scanAgainBtn) {
                scanAgainBtn.addEventListener('click', () => {
                    // Reset state
                    qrScannedData = null;
                    selectedItemId = null;
                    selectedItemType = null;
                    cameraStatus.innerHTML = '<small style="color: #059669;">Position QR code in frame</small>';
                    linkBtn.disabled = true;

                    // Clear list and show loading icon
                    const itemType = scanMode === 'racket' ? 'rackets' : 'cricket bats';
                    unlinkedList.innerHTML = `<div style="padding: 20px; text-align: center; color: #9ca3af;"><i class="bi bi-hourglass-split" style="font-size: 32px; color: #d1d5db; margin-bottom: 10px; display: block;"></i><small>Loading ${itemType}...</small></div>`;

                    // Reset racket selection radio buttons
                    document.querySelectorAll('input[name="selectedItem"]').forEach(r => r.checked = false);

                    // Show camera, hide Scan Again button
                    cameraSection.style.display = 'block';
                    scanAgainBtn.style.display = 'none';

                    // Restart camera
                    startCamera();
                });
            }

            // Fetch and display available items (rackets/cricket bats) for QR
            async function fetchAvailableRackets(qrCode) {
                try {
                    const itemType = scanMode === 'racket' ? 'rackets' : 'cricket bats';
                    console.log(`[QR-SCAN] Fetching ${itemType} for QR: ${qrCode}`);

                    // Show loading overlay - same as "Linking QR"
                    showLoadingOverlay(`Loading ${itemType}...`);

                    const response = await fetch(`${API_BASE_URL}/api/qr/${encodeURIComponent(qrCode)}?mode=${scanMode}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    console.log(`[QR-SCAN] Response status: ${response.status}`);

                    const data = await response.json();
                    console.log(`[QR-SCAN] Response data:`, data);

                    if (!data.success) {
                        hideLoadingOverlay();
                        throw new Error(data.message || `Failed to fetch QR data`);
                    }

                    // If QR is already linked, show details and status update options
                    if (data.linked) {
                        hideLoadingOverlay();
                        const order = data.order;
                        const rackets = order.rackets || [];
                        const linkedRacket = rackets.find(r => r.isLinkedToScannedQr);

                        if (linkedRacket) {
                            // Check if already completed
                            if (linkedRacket.status === 2) {
                                showToast(`${scanMode === 'racket' ? 'Racket' : 'Cricket Bat'} already completed`, 'error');
                                unlinkedList.innerHTML = '';
                                qrModal.style.display = 'none';
                                stopCamera();
                                return;
                            }

                            // Display linked item details with status update options
                            const itemName = linkedRacket.racketName || 'Item';
                            // If status is not set, default to 0 (Not Started)
                            const racketStatus = typeof linkedRacket.status === 'number' ? linkedRacket.status : 0;
                            const statusText = racketStatus === 0 ? 'Not Started' : racketStatus === 1 ? 'In Progress' : 'Completed';
                            const actionLabel = scanMode === 'racket' ?
                                (racketStatus === 0 ? 'Start Stringing' : 'Mark Complete') :
                                (racketStatus === 0 ? 'Start Knocking' : 'Mark Complete');

                            // Extract string details if available - format like stringing tab
                            let stringDetailsHtml = '';
                            if (linkedRacket.string || linkedRacket.tension) {
                                let stringName = linkedRacket.string || 'N/A';
                                const tension = linkedRacket.tension || 'N/A';
                                // Remove brand prefix to match stringing tab format (e.g., Yonex BG 65 -> BG 65)
                                const brandPrefixes = ['Yonex ', 'Li-Ning ', 'Hundred ', 'KIZUNA ', 'Head ', 'Babolat ', 'Gravity '];
                                for (const prefix of brandPrefixes) {
                                    if (stringName.startsWith(prefix)) {
                                        stringName = stringName.substring(prefix.length);
                                        break;
                                    }
                                }
                                stringDetailsHtml = `<p style="margin: 5px 0; color: #6b7280; font-size: 14px;">${stringName} @ ${tension} lbs</p>`;
                            }

                            let detailsHtml = `
                                <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                    <div style="margin-bottom: 15px;">
                                        <h6 style="margin: 0 0 10px 0; color: #1f2937; font-weight: 600;">Customer: ${order.customerName}</h6>
                                        <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">Order: ${order.orderId}</p>
                                        <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">Store: ${order.store}</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                        <p style="margin: 5px 0; color: #1f2937; font-weight: 500;">${scanMode === 'racket' ? 'Racket' : 'Bat'}: ${itemName}</p>
                                        ${stringDetailsHtml}
                                        <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">Status: <span style="font-weight: 600; color: #3b82f6;">${statusText}</span></p>
                                    </div>
                                    
                                    <button id="updateStatusBtn" style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                        ${actionLabel}
                                    </button>
                                </div>
                            `;

                            unlinkedList.innerHTML = detailsHtml;

                            // Disable both Link QR and Scan Again buttons since a racket is already linked
                            linkBtn.disabled = true;
                            linkBtn.style.opacity = '0.5';
                            linkBtn.style.cursor = 'not-allowed';
                            scanAgainBtn.disabled = true;
                            scanAgainBtn.style.opacity = '0.5';
                            scanAgainBtn.style.cursor = 'not-allowed';

                            // Add event listener for status update button
                            const updateBtn = document.getElementById('updateStatusBtn');
                            if (updateBtn) {
                                updateBtn.addEventListener('click', async () => {
                                    try {
                                        // Show loading overlay
                                        const actionLabel = scanMode === 'racket' ?
                                            (racketStatus === 0 ? 'Starting stringing' : 'Marking complete') :
                                            (racketStatus === 0 ? 'Starting knocking' : 'Marking complete');
                                        showLoadingOverlay(actionLabel + '...');

                                        // Use racketStatus variable consistently
                                        const newStatus = racketStatus === 0 ? 1 : 2;
                                        const endpoint = scanMode === 'racket' ?
                                            `${API_BASE_URL}/api/orders/${order.orderId}/status-by-racket/${linkedRacket.id}` :
                                            `${API_BASE_URL}/api/orders/${order.orderId}/status-by-bat/${linkedRacket.id}`;

                                        // Use the authToken variable that's already in scope
                                        if (!authToken) {
                                            hideLoadingOverlay();
                                            showToast('Session expired. Please login again.', 'error');
                                            return;
                                        }

                                        const response = await fetch(endpoint, {
                                            method: 'PATCH',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${authToken}`
                                            },
                                            body: JSON.stringify({ status: newStatus })
                                        });

                                        // Check for 401 unauthorized
                                        if (response.status === 401) {
                                            hideLoadingOverlay();
                                            showToast('Session expired. Please login again.', 'error');
                                            sessionStorage.removeItem('staffAuthToken');
                                            location.reload();
                                            return;
                                        }

                                        const result = await response.json();

                                        if (result.success || result.order) {
                                            const actionName = scanMode === 'racket' ?
                                                (newStatus === 1 ? 'stringing' : 'completion') :
                                                (newStatus === 1 ? 'knocking' : 'completion');
                                            showToast(`${scanMode === 'racket' ? 'Racket' : 'Cricket Bat'} ${actionName} status updated successfully!`, 'success');

                                            // Clear the list, close modal and reset
                                            unlinkedList.innerHTML = '';
                                            qrScannedData = null;
                                            qrModal.style.display = 'none';
                                            hideLoadingOverlay();
                                            stopCamera();
                                        } else {
                                            hideLoadingOverlay();
                                            showToast('Failed to update status. Please try again.', 'error');
                                        }
                                    } catch (error) {
                                        hideLoadingOverlay();
                                        console.error('Error updating status:', error);
                                        showToast('Error updating status. Please try again.', 'error');
                                    }
                                });
                            }
                        }
                        return;
                    }

                    // Update cache with fresh data from server (limited to 5)
                    if (scanMode === 'racket') {
                        const racketsToDisplay = data.rackets || [];
                        if (racketsToDisplay.length > 0) {
                            cachedUnlinkedRackets = racketsToDisplay;
                            // Hide loading overlay and display updated list from server
                            hideLoadingOverlay();
                            unlinkedList.innerHTML = '';
                            displayCachedItems();
                        }
                    } else {
                        // For cricket bats, reuse rackets field from the same endpoint
                        const batsToDisplay = data.rackets || [];
                        if (batsToDisplay.length > 0) {
                            cachedUnlinkedBats = batsToDisplay;
                            // Hide loading overlay and display updated list
                            hideLoadingOverlay();
                            unlinkedList.innerHTML = '';
                            // Link QR button stays disabled until user selects an item
                            displayCachedItems();
                        }
                    }
                } catch (error) {
                    hideLoadingOverlay();
                    console.error('Error fetching QR data:', error);
                    // If fetch fails, keep showing cached data
                    console.log('[QR-SCAN] Keeping cached items displayed');
                }
            }            // Link QR with Selected Item
            if (linkBtn) {
                linkBtn.addEventListener('click', async () => {
                    if (!qrScannedData || !selectedItemId) {
                        const itemType = scanMode === 'racket' ? 'racket' : 'bat';
                        showToast(`Please scan a QR code and select a ${itemType}`, 'error');
                        return;
                    }

                    try {
                        // Set flag to prevent modal closure during linking
                        isLinkingInProgress = true;

                        // Show loading overlay instead of button state
                        showLoadingOverlay('Linking QR');
                        linkBtn.disabled = true;

                        // Get the order ID from the displayed item
                        const selectedRadio = document.querySelector('input[name="selectedItem"]:checked');
                        const selectedItem = selectedRadio?.closest('.list-group-item');
                        const orderIdText = selectedItem?.querySelector('.small.text-muted')?.textContent;
                        const orderId = orderIdText?.split(' â€¢')[0] || '';

                        if (!orderId) {
                            hideLoadingOverlay();
                            linkBtn.disabled = false;
                            showToast('Could not determine order. Please try again.', 'error');
                            return;
                        }

                        const itemType = scanMode === 'racket' ? 'racket' : 'cricket bat';
                        console.log(`[QR-LINK] Linking QR ${qrScannedData} to ${itemType} ${selectedItemId} in order ${orderId}`);

                        const body = {
                            orderId: orderId
                        };
                        if (scanMode === 'racket') {
                            body.racketId = selectedItemId;
                        } else {
                            body.batId = selectedItemId;
                        }

                        const response = await fetch(`${API_BASE_URL}/api/qr/${encodeURIComponent(qrScannedData)}/link`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(body)
                        });

                        const result = await response.json();
                        console.log(`[QR-LINK] Response:`, result);

                        if (!result.success) {
                            throw new Error(result.message || 'Failed to link QR code');
                        }

                        showToast('QR code linked successfully!', 'success');
                        hideLoadingOverlay();

                        // After linking, display the linked racket/bat with status instead of closing
                        // Extract the linked item details from the response
                        const linkedOrder = result.order || result.data || {};
                        const linkedRackets = linkedOrder.rackets || linkedOrder.racketDetails || [];
                        const linkedBats = linkedOrder.bats || linkedOrder.batDetails || [];

                        let justLinkedItem = null;

                        if (scanMode === 'racket') {
                            justLinkedItem = linkedRackets.find(r => r.id === selectedItemId);
                        } else {
                            justLinkedItem = linkedBats.find(b => b.id === selectedItemId);
                        }

                        // If we still can't find it in the response, try to reconstruct from cached data
                        if (!justLinkedItem) {
                            const cachedItems = scanMode === 'racket' ? cachedUnlinkedRackets : cachedUnlinkedBats;
                            justLinkedItem = cachedItems.find(item => item.id === selectedItemId);
                        }

                        if (justLinkedItem) {
                            // Display linked item details with status update options (same as already-linked state)
                            const itemName = justLinkedItem.racketName || justLinkedItem.batModel || 'Item';
                            const linkedStatus = typeof justLinkedItem.status === 'number' ? justLinkedItem.status : 0;
                            const statusText = linkedStatus === 0 ? 'Not Started' : linkedStatus === 1 ? 'In Progress' : 'Completed';
                            const actionLabel = scanMode === 'racket' ?
                                (linkedStatus === 0 ? 'Start Stringing' : 'Mark Complete') :
                                (linkedStatus === 0 ? 'Start Knocking' : 'Mark Complete');

                            // Extract string/batting details if available
                            let detailsHtml = '';
                            if (scanMode === 'racket') {
                                let stringName = justLinkedItem.string || 'N/A';
                                const tension = justLinkedItem.tension || 'N/A';
                                // Remove brand prefix to match stringing tab format
                                const brandPrefixes = ['Yonex ', 'Li-Ning ', 'Hundred ', 'KIZUNA ', 'Head ', 'Babolat ', 'Gravity '];
                                for (const prefix of brandPrefixes) {
                                    if (stringName.startsWith(prefix)) {
                                        stringName = stringName.substring(prefix.length);
                                        break;
                                    }
                                }
                                detailsHtml = `<p style="margin: 5px 0; color: #6b7280; font-size: 14px;">${stringName} @ ${tension} lbs</p>`;
                            } else {
                                // For cricket bats
                                const threadingValue = justLinkedItem.threading || 'none';
                                const packageValue = justLinkedItem.package ? `${justLinkedItem.package} balls` : '';
                                const threadingDisplay = threadingValue !== 'none' ? ` â€¢ ${threadingValue.charAt(0).toUpperCase() + threadingValue.slice(1)} Threading` : '';
                                const secondLine = `${packageValue}${threadingDisplay}`;
                                detailsHtml = `<p style="margin: 5px 0; color: #6b7280; font-size: 14px;">${secondLine}</p>`;
                            }

                            let displayHtml = `
                                <div style="margin-bottom: 10px; padding: 8px; background: #10b981; color: white; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center;">
                                    <i class="bi bi-check-circle"></i> Linked Item
                                </div>
                                <div style="padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                    <div style="margin-bottom: 15px;">
                                        <h6 style="margin: 0 0 10px 0; color: #1f2937; font-weight: 600;">Customer: ${linkedOrder.customerName || 'N/A'}</h6>
                                        <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">Order: ${linkedOrder.orderId || 'N/A'}</p>
                                        <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">Store: ${linkedOrder.store || 'N/A'}</p>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #10b981;">
                                        <p style="margin: 5px 0; color: #1f2937; font-weight: 500;">${scanMode === 'racket' ? 'Racket' : 'Bat'}: ${itemName}</p>
                                        ${detailsHtml}
                                        <p style="margin: 5px 0; color: #6b7280; font-size: 14px;">Status: <span style="font-weight: 600; color: #10b981;">âœ“ Just Linked</span></p>
                                    </div>
                                    
                                    <button id="updateStatusBtn" style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                        ${actionLabel}
                                    </button>
                                </div>
                            `;

                            unlinkedList.innerHTML = displayHtml;

                            // Close the modal after showing the linked item briefly and display success toast
                            setTimeout(() => {
                                qrModal.style.display = 'none';
                                stopCamera();
                                // Reload the current tab to show updated data
                                if (isAuthenticated) {
                                    loadTabData(currentStatus);
                                }
                            }, 1500);

                            // Linking is complete, reset flag
                            isLinkingInProgress = false;

                            // Add event listener for status update button
                            const updateBtn = document.getElementById('updateStatusBtn');
                            if (updateBtn) {
                                updateBtn.addEventListener('click', async () => {
                                    try {
                                        // Show loading overlay
                                        const actionLabel = scanMode === 'racket' ?
                                            (linkedStatus === 0 ? 'Starting stringing' : 'Marking complete') :
                                            (linkedStatus === 0 ? 'Starting knocking' : 'Marking complete');
                                        showLoadingOverlay(actionLabel + '...');

                                        const newStatus = linkedStatus === 0 ? 1 : 2;
                                        const endpoint = scanMode === 'racket' ?
                                            `${API_BASE_URL}/api/orders/${linkedOrder.orderId}/status-by-racket/${justLinkedItem.id}` :
                                            `${API_BASE_URL}/api/orders/${linkedOrder.orderId}/status-by-bat/${justLinkedItem.id}`;

                                        if (!authToken) {
                                            hideLoadingOverlay();
                                            showToast('Session expired. Please login again.', 'error');
                                            return;
                                        }

                                        const response = await fetch(endpoint, {
                                            method: 'PATCH',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${authToken}`
                                            },
                                            body: JSON.stringify({ status: newStatus })
                                        });

                                        // Check for 401 unauthorized
                                        if (response.status === 401) {
                                            hideLoadingOverlay();
                                            showToast('Session expired. Please login again.', 'error');
                                            sessionStorage.removeItem('staffAuthToken');
                                            location.reload();
                                            return;
                                        }

                                        const statusUpdateResult = await response.json();

                                        if (statusUpdateResult.success || statusUpdateResult.order) {
                                            const actionName = scanMode === 'racket' ?
                                                (newStatus === 1 ? 'stringing' : 'completion') :
                                                (newStatus === 1 ? 'knocking' : 'completion');
                                            showToast(`${scanMode === 'racket' ? 'Racket' : 'Cricket Bat'} ${actionName} status updated successfully!`, 'success');

                                            // Close modal and reset
                                            unlinkedList.innerHTML = '';
                                            qrScannedData = null;
                                            qrModal.style.display = 'none';
                                            hideLoadingOverlay();
                                            stopCamera();
                                        } else {
                                            hideLoadingOverlay();
                                            showToast('Failed to update status. Please try again.', 'error');
                                        }
                                    } catch (error) {
                                        hideLoadingOverlay();
                                        console.error('Error updating status:', error);
                                        showToast('Error updating status. Please try again.', 'error');
                                    }
                                });
                            }
                        } else {
                            // If we can't find the linked item details, just close and reload
                            qrModal.style.display = 'none';
                            stopCamera();
                            // Reload the current tab to show updated data
                            if (isAuthenticated) {
                                loadTabData(currentStatus);
                            }
                        }
                    } catch (error) {
                        hideLoadingOverlay();
                        linkBtn.disabled = false;
                        console.error('Error linking QR code:', error);
                        showToast('Error linking QR code: ' + error.message, 'error');
                    }
                });
            }

            // Initialize
            checkAuth();

            // Prefetch unlinked orders for faster QR scanning
            prefetchUnlinkedOrders();
        });
    </script>
</body>

</html>